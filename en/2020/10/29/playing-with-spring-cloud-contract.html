<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Blog">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Playing with Spring Cloud Contract</title>
  <meta name="description" content="In a previous post we saw how new needs arose in the field of testing derived from the evolution of application architectures. Through a simple example we es...">
  
  <meta name="keywords" content="testing,calidad,softwarequality,QA,contracttesting,providerdrivencontracttesting,springcloudcontract">
  

  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@wearearima">
  <meta name="twitter:creator" content="@jessica">
  <meta name="twitter:title"   content="Playing with Spring Cloud Contract">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary_large_image">
  <meta name="twitter:image" content="https://blog.arima.eu/assets/images/2020-10-15-playing-with-spring-cloud-contract/header.jpg">
  
  <!-- end of Twitter cards -->

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.arima.eu/en/2020/10/29/playing-with-spring-cloud-contract.html">
  <link rel="alternate" type="application/rss+xml" title="ARIMA" href="/en/feed.xml">

  <!-- SEO Recipes (http://polyglot.untra.io/seo/) -->
  <meta http-equiv="Content-Language" content="en">
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/en/2020/10/29/playing-with-spring-cloud-contract.html" />
  
  
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/es/2020/10/29/playing-with-spring-cloud-contract.html" />
  
  
  <link rel="alternate"
      hreflang="en"
      href="https://blog.arima.eu/en/2020/10/29/playing-with-spring-cloud-contract.html" />
  

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120217722-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120217722-1');
</script>
  
</head>

  <body>
    <nav class="toolbar">
    <div class="wrapper">    
        <a href="/en/">
            <div class="toolbar__logo">
                <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" width="100%" height="100%" viewBox="0 0 33 6">
    <path id="path24" d="m30.346988508615652,-0.000015174522529526127 l-0.6439224998849951,0 l-2.7763635316117727,6.135695064030662 l0.7050150612484405,0 l2.3859233880279893,-5.335002838884215 l2.3660424189063254,5.335002838884215 l0.739668694925785,0 L30.346988508615652,-0.000015174522529526127 zm-8.274141805179609,3.3681675186951847 l-2.2194202716340565,-3.324608867598761 l-0.6962481061149294,0 l0,6.092136412934239 l0.6700853029999622,0 l0,-4.926062349034439 l2.2194202716340565,3.2553706313868567 l0.034929758248478535,0 l2.2192131782057056,-3.2639304930920168 l0,4.934622210739599 l0.6873430886958508,0 l0,-6.092136412934239 l-0.6961100438293623,0 l-2.2192131782057056,3.324608867598761 zm-9.143036799396208,-1.5057072863948877 c0,-1.0964906719739773 -0.8613705996531913,-1.8189015812038738 -2.201748299081466,-1.8189015812038738 l-2.619662837493104,0 l0,6.092136412934239 l0.6876192132669849,0 l0,-5.456842805897188 l1.8799251114245357,0 c0.9833486289517317,0 1.5576187057681203,0.4525681720889824 1.5576187057681203,1.2097017461390067 c0,0.7919252700129356 -0.7831583148794242,1.2620273523689407 -1.6968545207625496,1.2620273523689407 l0,0.6178287279128115 l1.7665759749739396,2.3672849794764295 l0.8442508762428699,0 l-1.8711581562910244,-2.4891249464894027 c0.9571858258367647,-0.17416557324290774 1.6534339319516944,-0.7659695603263191 1.6534339319516944,-1.7841098852409623 m2.7743616284710493,4.273234831730365 l0.6872050264102838,0 l0,-6.0920673817914555 l-0.6872050264102838,0 l0,6.0920673817914555 zM2.7761571742923965,-0.000015174522529526127 l-2.7761564381834223,6.135695064030662 l0.7048769989628736,0 l2.386061450313556,-5.335002838884215 l2.3658353254779745,5.335002838884215 l0.739668694925785,0 l-2.7761564381834223,-6.135695064030662 l-0.6441295933133457,0 z" stroke-width="0"/>
</svg>

            </div>
        </a>
        <!-- Language selector -->
        <div class="language-selector">
            
              
                <a class="unselected" href="/es/2020/10/29/playing-with-spring-cloud-contract.html">ES</a>
              
              
                &nbsp;|&nbsp;
              
            
              
                <b class="selected">EN</b>
              
              
            
         </div>
    </div>
</nav>
<div id="publisher_id" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Arima 100% Software Design" />
    <meta itemprop="url" content="https://arima.eu" />
    <div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content="https://arima.eu/img/logo.png" />
    </div>
</div>
    <main aria-label="Content">        
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting" itemref="publisher_id">
          <link itemprop="mainEntityOfPage" href="/en/2020/10/29/playing-with-spring-cloud-contract.html" />

          <header class="post-header">
            <div class="post-img" itemprop="image" itemscope itemtype="http://schema.org/ImageObject" style="background-image: url('https://blog.arima.eu/assets/images/2020-10-15-playing-with-spring-cloud-contract/header.jpg');">
              <meta itemprop="url" content="https://blog.arima.eu/assets/images/2020-10-15-playing-with-spring-cloud-contract/header.jpg" />
            </div>
            <div class="wrapper">
              <div class="post-info__container">
                <div class="post-info">
                  <h1 class="post-title" itemprop="name headline">Playing with Spring Cloud Contract</h1>
                    <div class="post-meta" itemscope itemtype="https://schema.org/Person" itemprop="author">
                      
                      <div class="author-photo">
                        <img itemprop="image" src="/assets/images/authors/jessica.png" alt="">
                      </div>
                      <div>
                        <span class="post-author" itemprop="name">Jessica Aguado</span>
                      </div>
                      <div>
                        <span class="post-date">29 Oct 2020</span>
                      </div>
                    </div>
                    <meta  itemprop="datePublished dateModified" content="29 Oct 2020" />
                </div>
              </div>
            </div>
          </header>
          <div class="wrapper">
            <div class="post-content" itemprop="articleBody">
              <p>In a <a href="https://blog.arima.eu/en/2020/09/03/contract-testing.html" target="_blank">previous post</a> we saw how new needs arose in the field of testing derived from the evolution of application architectures.</p>

<p>Through a simple example we established concepts such as <em>consumer</em>, <em>producer</em>, <em>service</em> and showed that just as important as testing the functionalities in <em>consumer</em> and <em>producer</em> independently is, so also is ensuring that the interaction between them both is right.</p>

<p>We introduced the concept of <strong>Contract Testing</strong>, which we delved into in another <a href="https://blog.arima.eu/en/2020/10/09/contract-testing-approach.html" target="_blank">post</a> which allowed us to get familiar with the different approaches and tools.</p>

<p>Now, with all the information to hand, it’s time to put all those ideas into code. We will do it step by step, starting from the example in the first post, which we can download from <a href="https://github.com/wearearima/time-report-contractTesting" target="_blank">here</a>. Remember that here we highlighted the problem that we might encounter: an application that fails in production despite passing all the unit and integration tests.</p>

<p>We have chosen the <strong>producer driven</strong> approach and as a tool we will use <a href="https://spring.io/projects/spring-cloud-contract" target="_blank"><strong>Spring Cloud Contract</strong></a>. The code is available on <a href="https://github.com/wearearima/time-report-contractTesting-02" target="_blank">Github</a>. Let’s go!</p>

<h1 id="1-define-the-contract">1. Define the contract</h1>

<p>We will start by defining the agreement: we will write the specification that <em>consumer</em> and <em>producer</em> have to comply with for the communication to work properly. In Spring Cloud Contract the term <strong>contract</strong> is used. It can be defined in different ways (groovy, yaml, java, kotlin) and we have chosen <code class="highlighter-rouge">yaml</code> because for this example, we thought it would be easy to read.</p>

<p>For our use case we define the following contract:</p>

<h5 id="worklogsforworkeranddayyaml">worklogsForWorkerAndDay.yaml</h5>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">description</span><span class="pi">:</span> <span class="s">Given a worker's username and a day it returns the worklog info for that worker and day</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">worklogsForWokerAndDay_success</span>
<span class="na">request</span><span class="pi">:</span>
   <span class="na">urlPath</span><span class="pi">:</span> <span class="s">/worklogs/worker/JESSI</span>
   <span class="na">queryParameters</span><span class="pi">:</span>
      <span class="na">day</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2020-05-05"</span>
   <span class="na">method</span><span class="pi">:</span> <span class="s">GET</span>
   <span class="na">matchers</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span>
      <span class="na">regex</span><span class="pi">:</span> <span class="s">/worklogs/worker/([a-zA-Z]*)</span>
    <span class="na">queryParameters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">day</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">matching</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">(</span><span class="se">\\</span><span class="s">d</span><span class="se">\\</span><span class="s">d</span><span class="se">\\</span><span class="s">d</span><span class="se">\\</span><span class="s">d)-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])"</span>
<span class="na">response</span><span class="pi">:</span>
   <span class="na">status</span><span class="pi">:</span> <span class="m">200</span>
   <span class="na">headers</span><span class="pi">:</span>
      <span class="na">Content-Type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">application/json"</span>
   <span class="na">bodyFromFile</span><span class="pi">:</span> <span class="s">worklogsForJessiOn20200505Response.json</span>
</code></pre></div></div>

<p>In this case we are establishing the following agreement:<br />
<em>For a <strong>request</strong> with: a username and a date (whose format we also specify), the <strong>response</strong> will be: <code class="highlighter-rouge">status 200</code> and a <code class="highlighter-rouge">JSON</code> (whose content we establish through a <a href="https://github.com/wearearima/time-report-contractTesting-02/blob/master/timeReports-producer/src/test/resources/contracts/worklogs/worklogsForJessiOn20200505Response.json" target="_blank">file</a>).</em></p>

<p>This contract must be accessible to the <em>producer</em>. In this case, and for simplicity, it will be in the <em>producer</em> folder <code class="highlighter-rouge">/test/resources/contracts/worklogs</code>.</p>

<p>Once we have defined the contract, we will have to complete the implementation that complies with it and the necessary tests to verify it. In this example we were already starting from the implementation, so let’s get on with the tests!</p>

<h1 id="2-producer-configure-dependencies-in-the-pomxml">2. Producer: configure dependencies in the pom.xml</h1>

<p>We modify the <code class="highlighter-rouge">pom.xml</code> by adding the Spring Cloud Contract Verifier dependency and the <code class="highlighter-rouge">spring-cloud-contract-maven-plugin</code>. With the latter we will automatically achieve:</p>

<ul>
  <li>Generation of tests that verify that our <em>producer</em> complies with the contract</li>
  <li>Creation of a stub that will allow the <em>consumer</em> to generate a <a href="http://wiremock.org/" target="_blank">WireMock</a> (which will comply with the contract) against which to run its tests</li>
</ul>

<h4 id="producer--pomxml">Producer | pom.xml</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nt">&lt;dependencies&gt;</span>
  ...
  <span class="c">&lt;!-- Spring Cloud Contract Verifier --&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-contract-verifier<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
...
<span class="nt">&lt;build&gt;</span>
  <span class="nt">&lt;plugins&gt;</span>
    ...
    <span class="nt">&lt;plugin&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-cloud-contract-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>3.0.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;extensions&gt;</span>true<span class="nt">&lt;/extensions&gt;</span>
      <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;testFramework&gt;</span>JUNIT5<span class="nt">&lt;/testFramework&gt;</span>
        <span class="nt">&lt;packageWithBaseClasses&gt;</span>eu.arima.tr<span class="nt">&lt;/packageWithBaseClasses&gt;</span>
      <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>
  <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>

<span class="nt">&lt;dependencyManagement&gt;</span>
  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${spring-cloud.version}<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/dependencyManagement&gt;</span>
...
</code></pre></div></div>

<p>As shown in the <code class="highlighter-rouge">pom.xml</code> in addition to the dependencies, we have configured some of the plugin properties:</p>
<ul>
  <li>We have indicated that the test framework will be JUnit 5</li>
  <li>We have indicated that the package that will contain the <em>test base class</em> will be <code class="highlighter-rouge">eu.arima.tr</code></li>
</ul>

<p>What’s this about the <em>test base class</em>? According to the specification, we must generate a base class for the autogenerated tests to extend. This class must contain all the information necessary for executing the tests (for example, we could configure mocks of some beans, populate the database with specific data for tests …).<br />
For this example we have created a very simple base class whose only responsibility will be to start up the application context. We have defined the contract in the <code class="highlighter-rouge">contracts/worklogs</code> folder, therefore (based on the documentation that indicates that the name is inferred from the names of the last two folders), the class is called <code class="highlighter-rouge">WorklogsBase.java</code>.</p>

<h4 id="producer--worklogsbasejava">Producer | WorklogsBase.java</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">eu</span><span class="o">.</span><span class="na">arima</span><span class="o">.</span><span class="na">tr</span><span class="o">;</span>

<span class="nd">@ExtendWith</span><span class="o">(</span><span class="nc">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">WorklogsBase</span> <span class="o">{</span>
  <span class="nd">@Autowired</span>
  <span class="nc">WebApplicationContext</span> <span class="n">context</span><span class="o">;</span>

  <span class="nd">@BeforeEach</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">RestAssuredMockMvc</span><span class="o">.</span><span class="na">webAppContextSetup</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">);</span>
  <span class="o">}</span> 
<span class="o">}</span> 
</code></pre></div></div>

<p>The plugin supports the configuration of other parameters as explained in the <a href="https://cloud.spring.io/spring-cloud-contract/spring-cloud-contract-maven-plugin/index.html" target="_blank">plugin documentation</a>, such as: where the contracts are, how to generate the different elements, etc.</p>

<h1 id="3-producer-create-and-run-tests">3. Producer: create and run tests</h1>

<p>As we mentioned in the previous section, with this plugin we can automatically generate the tests that ensure that the <em>producer</em> complies with the contract. To do this we execute the command <code class="highlighter-rouge">./mvnw clean test</code> and we see that:</p>

<ul>
  <li>The <em>producer</em> test classes are generated</li>
  <li>The tests are run</li>
  <li>In addition, a <code class="highlighter-rouge">.jar</code> is created (which for now we leave parked)</li>
</ul>

<p>What about the self-generated tests? They are in the <code class="highlighter-rouge">generated-test-sources</code> folder. In this specific case, as we have a single folder, a single class is generated:</p>

<h4 id="producer--worklogstestjava">Producer | WorklogsTest.java</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WorklogsTest</span> <span class="kd">extends</span> <span class="nc">WorklogsBase</span> <span class="o">{</span>

 <span class="nd">@Test</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate_worklogsForWokerAndDay_success</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="c1">// given:</span>
   <span class="nc">MockMvcRequestSpecification</span> <span class="n">request</span> <span class="o">=</span> <span class="n">given</span><span class="o">();</span>


  <span class="c1">// when:</span>
   <span class="nc">ResponseOptions</span> <span class="n">response</span> <span class="o">=</span> <span class="n">given</span><span class="o">().</span><span class="na">spec</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
     <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"day"</span><span class="o">,</span><span class="s">"2020-05-05"</span><span class="o">)</span>
     <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/worklogs/worker/JESSI"</span><span class="o">);</span>

  <span class="c1">// then:</span>
   <span class="n">assertThat</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">statusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
   <span class="n">assertThat</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">)).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">);</span>

  <span class="c1">// and:</span>
   <span class="nc">DocumentContext</span> <span class="n">parsedJson</span> <span class="o">=</span> <span class="nc">JsonPath</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">asString</span><span class="o">());</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['worker']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['worker']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['userName']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"JESSI"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['worker']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['new']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['task']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['task']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['name']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Daily meeting"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['task']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['new']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['day']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"2020-05-05"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['fromTime']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"08:30:00"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['toTime']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"09:30:00"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['description']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Daily meeting"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['new']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['task']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['task']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['name']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Implement the use case Create report for user and day"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['fromTime']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"09:30:00"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['toTime']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"16:30:00"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['description']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Create database and queries"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['toTime']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"11:00:00"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['description']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Create de frontend form for selecting user and date"</span><span class="o">);</span>
 <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>As we can see, there is a test method for the definition of the contract. If we had more than one, then we would have a test for each of them.</p>

<p>In the test that has been generated, we see how an <code class="highlighter-rouge">assert</code> is made to check that the response <code class="highlighter-rouge">statusCode</code> is as expected. We also see how it is verified that the type of response is a <code class="highlighter-rouge">json</code> and how the <code class="highlighter-rouge">.json</code> file has been parsed (which we referenced in the specification) to make the necessary <code class="highlighter-rouge">asserts</code> that ensure the response is as expected.</p>

<p><strong>And from eclipse?</strong></p>

<p>I personally use eclipse in my development, so I am interested in being able to run it from the IDE. Obviously we need it to be generated first and we have already seen how we should do it through <code class="highlighter-rouge">./mvnw clean test</code>. But if I have not changed the contract and it is not necessary to regenerate the tests and I am also developing and I want to pass all the tests, how do I do it? As they are autogenerated classes, it is necessary to add the <code class="highlighter-rouge">generated-test-sources</code> folders to the buildpath. For example, in this case:</p>

<p><img src="/assets/images/2020-10-15-playing-with-spring-cloud-contract/buildpath_config.png" alt="Configuration of the buildpath to run the tests from eclipse" class="center" /></p>

<h1 id="4-consumer-configure-dependencies">4. Consumer: configure dependencies</h1>

<p>Unlike the <em>producer</em>, the tests in the <em>consumer</em> related to the contract are not generated automatically. But we are not alone: ​​remember that at the same time that the <em>producer</em> tests were created, a <code class="highlighter-rouge">.jar</code> was also generated with the stub that will allow us to simulate the calls to the <em>producer</em> from the <em>consumer</em> tests.</p>

<p>In our case, the jar is: <code class="highlighter-rouge">timeReports-producer-0.0.1-SNAPSHOT-stubs.jar</code> which we can find in the <em>producer</em> <code class="highlighter-rouge">target</code>folder.</p>

<p>In this case, having both projects locally, if instead of executing the command <code class="highlighter-rouge">./mvnw clean test</code> (in the <em>producer</em>) we run <code class="highlighter-rouge">./mvnw clean install</code> we will have the said jar directly in our local maven repository, with which we can configure our <em>consumer</em> to access it.</p>

<p>In order to have access to it, we add the following dependency in the <code class="highlighter-rouge">pom.xml</code>:</p>

<h4 id="consumer--pomxml">Consumer | pom.xml</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
  <span class="nt">&lt;dependencies&gt;</span>
  ...
    <span class="c">&lt;!-- PRODUCER STUB --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>eu.arima.tr<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>timeReports-producer<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;classifier&gt;</span>stubs<span class="nt">&lt;/classifier&gt;</span>
        <span class="nt">&lt;version&gt;</span>0.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  ...
  <span class="nt">&lt;/dependencies&gt;</span>
...  
</code></pre></div></div>

<p>Also, we must not forget the Spring Cloud Contract dependency to be able to execute the added stub.</p>

<h4 id="consumer--pomxml-1">Consumer | pom.xml</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
  <span class="nt">&lt;dependencies&gt;</span>
  ...
    <span class="c">&lt;!-- SPRING CLOUD CONTRACT --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-contract-stub-runner<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  ...
  <span class="nt">&lt;/dependencies&gt;</span>

  <span class="nt">&lt;dependencyManagement&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${spring-cloud.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
   <span class="nt">&lt;/dependencies&gt;</span>
 <span class="nt">&lt;/dependencyManagement&gt;</span>
...  
</code></pre></div></div>

<h1 id="5-consumer-create-and-run-tests">5. Consumer: create and run tests</h1>

<p>Once the dependencies are added, we can create the WireMock based on that stub and create our tests. We will do it with the annotation <code class="highlighter-rouge">@AutoConfigureStubRunner</code> where we indicate our stub so it will be downloaded and registered automatically in the Wiremock. An example might be:</p>

<h5 id="consumer--reportsservicecontracttestjava">Consumer | ReportsServiceContractTest.java</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ExtendWith</span><span class="o">(</span><span class="nc">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="nd">@AutoConfigureStubRunner</span><span class="o">(</span><span class="n">ids</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"eu.arima.tr:timeReports-producer:+:stubs:"</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReportsServiceContractTest</span> <span class="o">{</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">ReportsService</span> <span class="n">reportsService</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kt">void</span> <span class="nf">test_getDayStatusSummaryForWorkerAndDay</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">LocalDate</span> <span class="n">dateFromProducerTest</span> <span class="o">=</span> <span class="nc">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">workerFromProducerTest</span> <span class="o">=</span> <span class="s">"TestUser"</span><span class="o">;</span>
    <span class="nc">DayStatusSummary</span> <span class="n">result</span> <span class="o">=</span> <span class="n">reportsService</span><span class="o">.</span><span class="na">getDayStatusSummaryForWorkerAndDay</span><span class="o">(</span><span class="n">workerFromProducerTest</span><span class="o">,</span>
				<span class="n">dateFromProducerTest</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">workerFromProducerTest</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">getWorkerUserName</span><span class="o">());</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">dateFromProducerTest</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">getDate</span><span class="o">());</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>With this, we would already have the communication between the two tested, making sure that if at any time there was a modification of the contract in either of the two components, the tests of the other would fail. Let’s see it.</p>

<h2 id="are-we-able-to-deploy-in-production-with-the-certainty-that-everything-works">Are we able to deploy in production with the certainty that everything works?</h2>

<p>This was the problem we encountered in the <a href="https://blog.arima.eu/en/2020/09/03/contract-testing.html" target="_blank">previous post</a>: despite having tested <em>consumer</em> and <em>producer</em>, we were not able to know if anything was wrong until we reached production. Will we be able to detect it now?</p>

<p>Suppose we make the same change that we proposed in that post:</p>

<h5 id="producer--worklogcontrollerjava">Producer | WorklogController.java</h5>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@RestController</span>
@RequestMapping("/worklogs")
<span class="p">public class WorklogController {
</span>
  ...

  @GetMapping("/worker/{workerUserName}")
  public List&lt;Worklog&gt; getReportForWorkerAndDay(
                       @PathVariable("workerUserName") String workerUserName, 
<span class="gd">-                      @RequestParam("day") LocalDate day) {
</span><span class="gi">+                      @RequestParam("date") LocalDate day) {    
</span>    return reportsService.getWorklogsForWorkerAndDay(workerUserName, day);
  }

}
</code></pre></div></div>

<p>We run the tests and indeed they fail: both the unitary one we have and the self-generated one. And why is this? Because we have actually modified the contract. We update the contract and correct the tests that fail:</p>

<h5 id="worklogsforworkeranddayyaml-1">worklogsForWorkerAndDay.yaml</h5>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">request:
</span>   urlPath: /worklogs/worker/JESSI
   queryParameters:
<span class="gd">-      day: "2020-05-05"
</span><span class="gi">+      date: "2020-05-05"
</span>   method: GET
   matchers:
    url:
      regex: /worklogs/worker/([a-zA-Z]*)
    queryParameters:
<span class="gd">-      - key: day
</span><span class="gi">+      - key: date
</span>        type: matching
        value: "(\\d\\d\\d\\d)-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])"
</code></pre></div></div>

<p>We run <code class="highlighter-rouge">./mvnw clean test</code> and now all our tests pass. Right! Let’s see how the autogenerated test has changed.</p>

<h5 id="producer--worklogstestjava-1">Producer | WorklogsTest.java</h5>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@Test</span>
public void validate_worklogsForWokerAndDay_success() throws Exception {
  // given:
  MockMvcRequestSpecification request = given();

  // when:
  ResponseOptions response = given().spec(request)
<span class="gd">-	      .queryParam("day","2020-05-05")
</span><span class="gi">+	      .queryParam("date","2020-05-05")
</span>        .get("/worklogs/worker/JESSI");
</code></pre></div></div>

<p>As we have changed the contract, we must send the update to the <em>consumer</em>, so we execute <code class="highlighter-rouge">./mvnw clean install</code> in the <em>producer</em> and run the <em>consumer</em> tests with <code class="highlighter-rouge">./mvnw clean test</code>.</p>

<p>What’s going on? Although the unit tests from before continue to work correctly, the new added test fails: it shows us that something has changed in the contract, so the application will not work. Right! <strong>Goal achieved: we have detected the problem before deployment to production</strong>.</p>

<p>We modify the <em>consumer</em> implementation:</p>

<h4 id="consumer--reportsservicejava">Consumer | ReportsService.java</h4>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">public DayStatusSummary getDayStatusSummaryForWorkerAndDay(String workerUserName, LocalDate date) {
</span>  // retrieve worklogs for worker and day
  List&lt;WorklogInfo&gt; worklogsForDay = webClient.get().uri(uriBuilder -&gt; uriBuilder
<span class="gd">-	    .path("/worklogs/worker/{workerUserName}").queryParam("day", date).build(workerUserName)).retrieve()
</span><span class="gi">+	    .path("/worklogs/worker/{workerUserName}").queryParam("date", date).build(workerUserName)).retrieve()
</span>      .bodyToFlux(WorklogInfo.class).collectList().block();

  int totalDuration = worklogsForDay.stream().mapToInt(WorklogInfo::getDuration).sum();
</code></pre></div></div>

<p>We run the tests, and we see that when changing the implementation, the unit tests have also stopped working (logically). Therefore, all we need to do is correct them.</p>

<p>As we have seen in the example, it is important that when the contract changes, both <em>consumer</em> and <em>producer</em> are aware of that change.</p>

<p>In this case, as it is from the <em>producer</em> where the change is made, it is important that the <em>consumer</em> receives the new specification through the stub (if not, the tests will continue to pass). In our example it is simple because we have everything locally. It helps us to explain the concept in a simple way, but we should not forget that it does not reflect reality, where often, different people are working on one or the other, without needing to have projects locally.
There are many ways to organize the code and therefore there are different solutions, which should be analyzed depending on the project and its requirements. The most important questions to be answered would be:</p>

<ul>
  <li><strong>Where do we place the contracts?</strong> Could they be in the project itself (as in the example) or maybe it would be better if they were in their own github repository?</li>
  <li><strong>How do we manage the <em>producer</em> stub?</strong> Could we deploy it in a maven repo?</li>
  <li><strong>How do we manage versioning?</strong> Will it be the same as that of the <em>producer</em> or will it be independent?</li>
</ul>

<p>We are not going to go into evaluating these and many other things, which should be taken into account when putting it into practice because the answer will be <em>it depends</em>. It depends on the project, on the organization of the teams, … In the Spring Cloud Contract documentation there are different recommendations and examples that could be useful.</p>

            </div>

            
          </div>
        </article>
      </div>
    </main>

    <footer>
    <div class="wrapper">
        <div class="footer__container">
            <div class="footer__sello">
                <img src="/assets/images/arima_sello_white.png" alt="" />
            </div>
            <div class="footer__content">
                <div class="footer__data">
                    <dl>
                        <dt>web</dt>
                        <dd><a itemprop="sameAs" href="https://www.arima.eu/en/">arima.eu</a></dd>
                    </dl>
                    <dl>
                        <dt>social</dt>
                        <dd>
                            <a itemprop="sameAs" href="https://github.com/wearearima" class="social"><span class="icon-github"></span></a>
                            <a itemprop="sameAs" href="https://twitter.com/wearearima" class="social"><span class="icon-twitter"></span></a>
                            <a itemprop="sameAs" href="https://www.linkedin.com/company/arima-software-design/" class="social"><span class="icon-linkedin"></span></a>
                            <a itemprop="sameAs" href="/en/feed.xml" class="social"><span class="icon-feed"></span></a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>Privacy</dt>
                        <dd class="politica-cookies">
                            <a href="/en/cookies.html">Cookies Policy</a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</footer>
    <div class="cookies-message" id="cookies-message">
    <h4>This website uses cookies</h4>
    <p>This website uses cookies to improve user experience. By continuing to browse this website, you agree to the use of cookies as stated in our Cookies Policy.</p>
    <div class="buttons">
        <a class="button" href="/en/cookies.html">Read Cookies Policy</a>
        <button class="button" id="accept-cookies">Accept</button>
    </div>
</div>
<script>
    (function() {
        if(localStorage) {
            var cookiesAccepted = localStorage.getItem("cookies-accepted");
            if(cookiesAccepted) {
                hideCookiesMessage();
                
            } else {
                document.getElementById('accept-cookies').addEventListener("click", function() {
                    hideCookiesMessage();
                    localStorage.setItem("cookies-accepted", true);
                })
            }
        }
        function hideCookiesMessage() {
            document.getElementById('cookies-message').style.display = "none";
        }
    })();
</script>

  </body>

</html>