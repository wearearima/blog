<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Blog">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using Docker inside Kubernetes</title>
  <meta name="description" content="In a previous post I talked about the problem of granting privileges to a container and the risks that this entails. Today I want to present a specific case ...">
  
  <meta name="keywords" content="docker,kubernetes,k8s,jenkins,privileged">
  

  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@wearearima">
  <meta name="twitter:creator" content="@urko">
  <meta name="twitter:title"   content="Using Docker inside Kubernetes">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary_large_image">
  <meta name="twitter:image" content="https://blog.arima.eu/assets/images/2020-11-11-docker-en-kubernetes/whale.jpg">
  
  <!-- end of Twitter cards -->

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.arima.eu/en/2020/11/11/docker-en-kubernetes.html">
  <link rel="alternate" type="application/rss+xml" title="ARIMA" href="/en/feed.xml">

  <!-- SEO Recipes (http://polyglot.untra.io/seo/) -->
  <meta http-equiv="Content-Language" content="en">
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/en/2020/11/11/docker-en-kubernetes.html" />
  
  
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/es/2020/11/11/docker-en-kubernetes.html" />
  
  
  <link rel="alternate"
      hreflang="en"
      href="https://blog.arima.eu/en/2020/11/11/docker-en-kubernetes.html" />
  

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120217722-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120217722-1');
</script>
  
</head>

  <body>
    <nav class="toolbar">
    <div class="wrapper">    
        <a href="/en/">
            <div class="toolbar__logo">
                <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" width="100%" height="100%" viewBox="0 0 33 6">
    <path id="path24" d="m30.346988508615652,-0.000015174522529526127 l-0.6439224998849951,0 l-2.7763635316117727,6.135695064030662 l0.7050150612484405,0 l2.3859233880279893,-5.335002838884215 l2.3660424189063254,5.335002838884215 l0.739668694925785,0 L30.346988508615652,-0.000015174522529526127 zm-8.274141805179609,3.3681675186951847 l-2.2194202716340565,-3.324608867598761 l-0.6962481061149294,0 l0,6.092136412934239 l0.6700853029999622,0 l0,-4.926062349034439 l2.2194202716340565,3.2553706313868567 l0.034929758248478535,0 l2.2192131782057056,-3.2639304930920168 l0,4.934622210739599 l0.6873430886958508,0 l0,-6.092136412934239 l-0.6961100438293623,0 l-2.2192131782057056,3.324608867598761 zm-9.143036799396208,-1.5057072863948877 c0,-1.0964906719739773 -0.8613705996531913,-1.8189015812038738 -2.201748299081466,-1.8189015812038738 l-2.619662837493104,0 l0,6.092136412934239 l0.6876192132669849,0 l0,-5.456842805897188 l1.8799251114245357,0 c0.9833486289517317,0 1.5576187057681203,0.4525681720889824 1.5576187057681203,1.2097017461390067 c0,0.7919252700129356 -0.7831583148794242,1.2620273523689407 -1.6968545207625496,1.2620273523689407 l0,0.6178287279128115 l1.7665759749739396,2.3672849794764295 l0.8442508762428699,0 l-1.8711581562910244,-2.4891249464894027 c0.9571858258367647,-0.17416557324290774 1.6534339319516944,-0.7659695603263191 1.6534339319516944,-1.7841098852409623 m2.7743616284710493,4.273234831730365 l0.6872050264102838,0 l0,-6.0920673817914555 l-0.6872050264102838,0 l0,6.0920673817914555 zM2.7761571742923965,-0.000015174522529526127 l-2.7761564381834223,6.135695064030662 l0.7048769989628736,0 l2.386061450313556,-5.335002838884215 l2.3658353254779745,5.335002838884215 l0.739668694925785,0 l-2.7761564381834223,-6.135695064030662 l-0.6441295933133457,0 z" stroke-width="0"/>
</svg>

            </div>
        </a>
        <!-- Language selector -->
        <div class="language-selector">
            
              
                <a class="unselected" href="/es/2020/11/11/docker-en-kubernetes.html">ES</a>
              
              
                &nbsp;|&nbsp;
              
            
              
                <b class="selected">EN</b>
              
              
            
         </div>
    </div>
</nav>
<div id="publisher_id" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Arima 100% Software Design" />
    <meta itemprop="url" content="https://arima.eu" />
    <div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content="https://arima.eu/img/logo.png" />
    </div>
</div>
    <main aria-label="Content">        
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting" itemref="publisher_id">
          <link itemprop="mainEntityOfPage" href="/en/2020/11/11/docker-en-kubernetes.html" />

          <header class="post-header">
            <div class="post-img" itemprop="image" itemscope itemtype="http://schema.org/ImageObject" style="background-image: url('https://blog.arima.eu/assets/images/2020-11-11-docker-en-kubernetes/whale.jpg');">
              <meta itemprop="url" content="https://blog.arima.eu/assets/images/2020-11-11-docker-en-kubernetes/whale.jpg" />
            </div>
            <div class="wrapper">
              <div class="post-info__container">
                <div class="post-info">
                  <h1 class="post-title" itemprop="name headline">Using Docker inside Kubernetes</h1>
                    <div class="post-meta" itemscope itemtype="https://schema.org/Person" itemprop="author">
                      
                      <div class="author-photo">
                        <img itemprop="image" src="/assets/images/authors/urko.png" alt="">
                      </div>
                      <div>
                        <span class="post-author" itemprop="name">Urko Lekuona</span>
                      </div>
                      <div>
                        <span class="post-date">11 Nov 2020</span>
                      </div>
                    </div>
                    <meta  itemprop="datePublished dateModified" content="11 Nov 2020" />
                </div>
              </div>
            </div>
          </header>
          <div class="wrapper">
            <div class="post-content" itemprop="articleBody">
              <p>In a <a href="/en/2020/09/10/deberias-utilizar-contenedores-privilegiados.html" target="_blank">previous post</a> I talked about the problem of granting privileges to a container and the risks that this entails. Today I want to present a specific case in which privileges are granted to a container and give some alternatives.</p>

<p>One of the most popular Continuous Integration tools is <a href="https://www.jenkins.io/" target="_blank">Jenkins</a>. It stands out for the amount of <em>plugins</em> that its community makes available to users and the freedom it grants to create <em>pipelines</em>. In addition, it offers us images with which it can be deployed in containers, including in a Kubernetes cluster!</p>

<p>And you would imagine that doing this should be pretty easy: you write a deployment that has a pod with the Jenkins image and you already have it (apart from installing plugins and configuring it). But what if I want to <em>build</em> images inside a <em>pipeline</em>?</p>

<p>Then you need the Docker CLI or <a href="https://plugins.jenkins.io/docker-plugin/" target="_blank">Docker plugin for Jenkins</a>. But these in turn need a Docker daemon to be able to make the corresponding requests. Things start getting complicated.</p>

<p>In this post we are going to explore, step by step, different approaches to deploying Jenkins with Docker in Kubernetes, and explain the evolution of each one.</p>

<h2 id="deployments">Deployments</h2>

<h3 id="1-docker-in-docker">1. Docker in Docker</h3>

<p>The most straightforward deployment is: You need a Docker daemon, so you install it. You take the Jenkins base image, install the Docker Engine, and create a custom image with both programs. Done!</p>

<p>This is possible; you can try it and it works. But it has certain implications that make it a bad option:</p>

<ul>
  <li><strong>Storage drivers</strong>: This problem arises from incompatibilities between different container file systems. Without going into detail, the containers use their own file systems (AUFS, BTRFS, Device Mapper, …) and these may not be compatible with each other. Depending on the type of system used by the node’s <em>container runtime</em> and that used by the container’s Docker daemon, problems can occur. These incompatibilities will probably be resolved as new versions of DinD (Docker in Docker) are released, but the risk remains latent.</li>
  <li><strong>Cache</strong>: If you want to use the Docker cache, which you probably will, and you want this cache to be accessible between different replicas, you should mount <code class="highlighter-rouge">/var/lib/docker</code> as a volume in each container. But Docker is intended to have exclusive access to this directory, and having two or more daemons accessing it at the same time can lead to data corruption problems.</li>
  <li><strong>Security</strong>: In order to run the Docker daemon inside a container, it must be run with privileges (<code class="highlighter-rouge">--privileged</code> in Docker or <code class="highlighter-rouge">securityContext.privileged: true</code> in Kubernetes). <strong>It is a requirement</strong>. This implies serious security risks, which we explain in <a href="/en/2020/09/10/deberias-utilizar-contenedores-privilegiados.html" target="_blank">this post</a>.</li>
</ul>

<p align="center">
    <img src="/assets/images/2020-11-11-docker-en-kubernetes/dind.png" />
</p>

<h3 id="2-docker-out-of-docker">2. Docker out of Docker</h3>

<p>In this variant, the cluster node Docker Daemon is used. To do this, you need to use an image with Jenkins and Docker CLI, mount the socket from the node to the container, and run the container with a group that has access to the socket.</p>

<p>Advantages over Docker in Docker:</p>

<ul>
  <li>Fixes cache and storage driver issues, which are inherent in Docker in Docker.</li>
  <li>We no longer create Docker daemons, but now reuse the existing one, which minimizes the use of resources.</li>
  <li>Avoids using privileged containers.</li>
</ul>

<p>But even so, it too has its problems:</p>

<ul>
  <li>We maintain security risks, since by having access to the Docker socket, we can very easily run a privileged container that will give us access to the <em>host</em></li>
  <li>Mounting node directories in a <em>pod</em> is bad practice. In fact, in this particular case, we cannot assume that the Docker socket will exist in the node. Depending on the <em>container runtime</em> of the cluster, it may not, so this solution might not be possible
    <blockquote>
      <p>Note: At the time of writing, the three major Kubernetes cloud providers (AWS, Azure and Google Cloud) provide nodes with the Docker runtime container, which does have a Docker socket.</p>
    </blockquote>
  </li>
  <li>As we are using the node daemon, all the containers we run are siblings of the container from which we created them. This carries risks in itself, since problems can occur when naming containers (naming two containers the same, or two volumes). Also, containers that have not been run from Kubernetes are not managed by Kubernetes, so we can run into resource allocation issues (container uses node resources but Kubernetes isn’t aware of it).</li>
</ul>

<p align="center">
    <img src="/assets/images/2020-11-11-docker-en-kubernetes/dood.png" />
</p>

<h3 id="3-docker-in-docker-sidecar">3. Docker in Docker sidecar</h3>

<p>The last alternative is to deploy two containers in the same pod, one with Jenkins and Docker CLI (as in Docker out of Docker) and another with Docker Engine, and use the TCP socket, since the network in the same pod is shared.</p>

<p>Although at first it may seem like taking a step backwards, there is an explanation: we are able to modify the Docker daemon options. And what do we want that for? We can install authorization <em>plugins</em> that prevent running privileged containers on that daemon (explained in more detail <a href="/en/2020/09/10/deberias-utilizar-contenedores-privilegiados.html" target="_blank">in the previous post</a>).</p>

<p>Advantages over Docker out of Docker:</p>

<ul>
  <li>We resolve security problems. By having no permissions to run privileged containers and not mounting any node directories, the node is isolated from the pod.</li>
</ul>

<p>Disadvantages:</p>

<ul>
  <li>We take a step backwards and return to the possible problems of cache and storage drivers.</li>
  <li>The container with Docker Engine will have to be run in privileged mode.</li>
</ul>

<p align="center">
    <img src="/assets/images/2020-11-11-docker-en-kubernetes/dind-sidecar.png" />
</p>

<h2 id="conclusion">Conclusion</h2>

<p>None of the methods for deploying Jenkins in Kubernetes is good. They all carry security risks and certain drawbacks, and we will have to decide which of them we prefer for our deployment. For interest, in the <a href="https://github.com/helm/charts/tree/master/stable/jenkins" target="_blank">official Helm chart</a> they resolve it by mounting the node <em>socket</em> (DooD) and without running privileged containers, but as we explained, this still has security risks.</p>

<p>The recommendation is not to use Docker as an image <em>building</em> tool in Jenkins. There are <em>daemonless</em> solutions that avoid the problems described in this document, which we will explore in a future post.</p>

            </div>

            
          </div>
        </article>
      </div>
    </main>

    <footer>
    <div class="wrapper">
        <div class="footer__container">
            <div class="footer__sello">
                <img src="/assets/images/arima_sello_white.png" alt="" />
            </div>
            <div class="footer__content">
                <div class="footer__data">
                    <dl>
                        <dt>web</dt>
                        <dd><a itemprop="sameAs" href="https://www.arima.eu/en/">arima.eu</a></dd>
                    </dl>
                    <dl>
                        <dt>social</dt>
                        <dd>
                            <a itemprop="sameAs" href="https://github.com/wearearima" class="social"><span class="icon-github"></span></a>
                            <a itemprop="sameAs" href="https://twitter.com/wearearima" class="social"><span class="icon-twitter"></span></a>
                            <a itemprop="sameAs" href="https://www.linkedin.com/company/arima-software-design/" class="social"><span class="icon-linkedin"></span></a>
                            <a itemprop="sameAs" href="/en/feed.xml" class="social"><span class="icon-feed"></span></a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>Privacy</dt>
                        <dd class="politica-cookies">
                            <a href="/en/cookies.html">Cookies Policy</a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</footer>
    <div class="cookies-message" id="cookies-message">
    <h4>This website uses cookies</h4>
    <p>This website uses cookies to improve user experience. By continuing to browse this website, you agree to the use of cookies as stated in our Cookies Policy.</p>
    <div class="buttons">
        <a class="button" href="/en/cookies.html">Read Cookies Policy</a>
        <button class="button" id="accept-cookies">Accept</button>
    </div>
</div>
<script>
    (function() {
        if(localStorage) {
            var cookiesAccepted = localStorage.getItem("cookies-accepted");
            if(cookiesAccepted) {
                hideCookiesMessage();
                
            } else {
                document.getElementById('accept-cookies').addEventListener("click", function() {
                    hideCookiesMessage();
                    localStorage.setItem("cookies-accepted", true);
                })
            }
        }
        function hideCookiesMessage() {
            document.getElementById('cookies-message').style.display = "none";
        }
    })();
</script>

  </body>

</html>