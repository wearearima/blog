<!DOCTYPE html>
<html lang="es" itemscope itemtype="http://schema.org/Blog">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Introducci√≥n a Contract Testing, estableciendo el contexto </title>
  <meta name="description" content="El desarrollo de aplicaciones ha evolucionado, y por tanto han surgido nuevas necesidades a la hora de hacer testing y nuevas herramientas para hacerles fren...">
  
  <meta name="keywords" content="testing,calidad,softwarequality,QA,contracttesting,consumer-drivencontract,consumerdrivencontract">
  

  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@wearearima">
  <meta name="twitter:creator" content="@jessica">
  <meta name="twitter:title"   content="Introducci√≥n a Contract Testing, estableciendo el contexto ">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary_large_image">
  <meta name="twitter:image" content="https://blog.arima.eu/assets/images/2020-09-03-contract-testing/header_recortado.png">
  
  <!-- end of Twitter cards -->

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.arima.eu/en/2020/09/03/contract-testing.html">
  <link rel="alternate" type="application/rss+xml" title="ARIMA" href="/en/feed.xml">

  <!-- SEO Recipes (http://polyglot.untra.io/seo/) -->
  <meta http-equiv="Content-Language" content="en">
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/en/2020/09/03/contract-testing.html" />
  
  
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/es/2020/09/03/contract-testing.html" />
  
  
  <link rel="alternate"
      hreflang="en"
      href="https://blog.arima.eu/en/2020/09/03/contract-testing.html" />
  

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120217722-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120217722-1');
</script>
  
</head>

  <body>
    <nav class="toolbar">
    <div class="wrapper">    
        <a href="/en/">
            <div class="toolbar__logo">
                <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" width="100%" height="100%" viewBox="0 0 33 6">
    <path id="path24" d="m30.346988508615652,-0.000015174522529526127 l-0.6439224998849951,0 l-2.7763635316117727,6.135695064030662 l0.7050150612484405,0 l2.3859233880279893,-5.335002838884215 l2.3660424189063254,5.335002838884215 l0.739668694925785,0 L30.346988508615652,-0.000015174522529526127 zm-8.274141805179609,3.3681675186951847 l-2.2194202716340565,-3.324608867598761 l-0.6962481061149294,0 l0,6.092136412934239 l0.6700853029999622,0 l0,-4.926062349034439 l2.2194202716340565,3.2553706313868567 l0.034929758248478535,0 l2.2192131782057056,-3.2639304930920168 l0,4.934622210739599 l0.6873430886958508,0 l0,-6.092136412934239 l-0.6961100438293623,0 l-2.2192131782057056,3.324608867598761 zm-9.143036799396208,-1.5057072863948877 c0,-1.0964906719739773 -0.8613705996531913,-1.8189015812038738 -2.201748299081466,-1.8189015812038738 l-2.619662837493104,0 l0,6.092136412934239 l0.6876192132669849,0 l0,-5.456842805897188 l1.8799251114245357,0 c0.9833486289517317,0 1.5576187057681203,0.4525681720889824 1.5576187057681203,1.2097017461390067 c0,0.7919252700129356 -0.7831583148794242,1.2620273523689407 -1.6968545207625496,1.2620273523689407 l0,0.6178287279128115 l1.7665759749739396,2.3672849794764295 l0.8442508762428699,0 l-1.8711581562910244,-2.4891249464894027 c0.9571858258367647,-0.17416557324290774 1.6534339319516944,-0.7659695603263191 1.6534339319516944,-1.7841098852409623 m2.7743616284710493,4.273234831730365 l0.6872050264102838,0 l0,-6.0920673817914555 l-0.6872050264102838,0 l0,6.0920673817914555 zM2.7761571742923965,-0.000015174522529526127 l-2.7761564381834223,6.135695064030662 l0.7048769989628736,0 l2.386061450313556,-5.335002838884215 l2.3658353254779745,5.335002838884215 l0.739668694925785,0 l-2.7761564381834223,-6.135695064030662 l-0.6441295933133457,0 z" stroke-width="0"/>
</svg>

            </div>
        </a>
        <!-- Language selector -->
        <div class="language-selector">
            
              
                <a class="unselected" href="/es/2020/09/03/contract-testing.html">ES</a>
              
              
                &nbsp;|&nbsp;
              
            
              
                <b class="selected">EN</b>
              
              
            
         </div>
    </div>
</nav>
<div id="publisher_id" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Arima 100% Software Design" />
    <meta itemprop="url" content="https://arima.eu" />
    <div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content="https://arima.eu/img/logo.png" />
    </div>
</div>
    <main aria-label="Content">        
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting" itemref="publisher_id">
          <link itemprop="mainEntityOfPage" href="/en/2020/09/03/contract-testing.html" />

          <header class="post-header">
            <div class="post-img" itemprop="image" itemscope itemtype="http://schema.org/ImageObject" style="background-image: url('https://blog.arima.eu/assets/images/2020-09-03-contract-testing/header_recortado.png');">
              <meta itemprop="url" content="https://blog.arima.eu/assets/images/2020-09-03-contract-testing/header_recortado.png" />
            </div>
            <div class="wrapper">
              <div class="post-info__container">
                <div class="post-info">
                  <h1 class="post-title" itemprop="name headline">Introducci√≥n a Contract Testing, estableciendo el contexto </h1>
                    <div class="post-meta" itemscope itemtype="https://schema.org/Person" itemprop="author">
                      
                      <div class="author-photo">
                        <img itemprop="image" src="/assets/images/authors/jessica.png" alt="">
                      </div>
                      <div>
                        <span class="post-author" itemprop="name">Jessica Aguado</span>
                      </div>
                      <div>
                        <span class="post-date">03 Sep 2020</span>
                      </div>
                    </div>
                    <meta  itemprop="datePublished dateModified" content="03 Sep 2020" />
                </div>
              </div>
            </div>
          </header>
          <div class="wrapper">
            <div class="post-content" itemprop="articleBody">
              <p>El desarrollo de aplicaciones ha evolucionado, y por tanto han surgido nuevas necesidades a la hora de hacer testing y nuevas herramientas para hacerles frente ¬°Vamos a verlo!</p>

<p>Hemos pasado de tener arquitecturas monol√≠ticas a aplicaciones basadas en (micro)servicios. ¬øPor qu√© digo (micro)servicios en lugar de microservicios? Porque aunque la literatura habla de la evoluci√≥n del desarrollo desde aplicaciones monol√≠ticas a aplicaciones basadas en microservicios, en la realidad nos encontramos muchas veces con la integraci√≥n de servicios (tal cual, sin necesidad de que sean micro). El concepto que nos ocupa aplica igual de bien al concepto de microservicios que al de servicios, as√≠ que de aqu√≠ en adelante simplificaremos utilizando el t√©rmino servicios.</p>

<p>Imaginemos una aplicaci√≥n para la gesti√≥n de partes de horas, las tareas, los informes de partes de horas‚Ä¶. El esquema de dicha aplicaci√≥n basada en servicios podr√≠a verse reflejado en el siguiente esquema.</p>

<p><img src="/assets/images/2020-09-03-contract-testing/01_schema_apps.jpg" alt="Ejemplo del esquema para aplicaciones basadas en servicios" class="center" /></p>

<p>El ejemplo que se muestra en la imagen anterior, es bastante sencillo. Tendr√≠amos 2 aplicaciones (una para la generaci√≥n de informes y otra para la gesti√≥n de tareas y partes de horas) y ambas tendr√≠an por un lado su implementaci√≥n de aplicaci√≥n web y su aplicaci√≥n m√≥vil. Los 4 servicios consumir√≠an un servicio transversal encargado de la gesti√≥n en bruto de tareas y worklogs. Podr√≠amos tener ejemplos m√°s complejos, donde un servicio consumiese otro que a su vez fuese consumido por un tercero, etc.  Pero para poder entender mejor el concepto, en lugar de a√±adir complejidad, vamos a simplificar a√∫n m√°s la foto haciendo zoom sobre la imagen anterior.</p>

<p><img src="/assets/images/2020-09-03-contract-testing/02_schema_app_simplificado.jpg" alt="Zoom de una parte del esquema" class="center" /></p>

<p>Como se muestra en la imagen, hemos reducido el ejemplo a una aplicaci√≥n web que se encarga de hacer informes sobre los partes de horas y que accede a un API REST para obtener informaci√≥n. Vamos a establecer la terminolog√≠a que utilizaremos de aqu√≠ en adelante:</p>
<ul>
  <li><strong>CONSUMER</strong>: Nos referiremos as√≠ a la aplicaci√≥n web o lo que es lo mismo, el servicio en su papel de consumir otro servicio</li>
  <li><strong>PRODUCER</strong>: Con este t√©rmino haremos referencia al API REST o lo que es lo mismo, el servicio en su papel de ofrecer su funcionalidad.</li>
</ul>

<p>Utilizaremos los nombres en ingl√©s ya que su traducci√≥n al castellano (consumidor y productor o proveedor) no me termina de convencer.</p>

<p>Teniendo claros estos dos conceptos, aprovecharemos para denominar <strong>SERVICIO</strong> a cada una de las funcionalidades ofertadas por el <em>producer</em>.</p>

<p>Vamos a ver unos fragmentos de c√≥digo de c√≥mo podr√≠an ser ambos:</p>

<h5 id="consumer--reportsservicejava">Consumer | ReportsService.java</h5>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReportsService</span> <span class="o">{</span>

  <span class="o">...</span>

  <span class="kd">public</span> <span class="nc">DayStatusSummary</span> <span class="nf">getDayStatusSummaryForWorkerAndDay</span><span class="o">(</span><span class="nc">String</span> <span class="n">workerUserName</span><span class="o">,</span> <span class="nc">LocalDate</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// retrieve worklogs for worker and day</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">WorklogInfo</span><span class="o">&gt;</span> <span class="n">worklogsForDay</span> <span class="o">=</span> <span class="n">webClient</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="n">uriBuilder</span> <span class="o">-&gt;</span> <span class="n">uriBuilder</span>
      <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">"/worklogs/worker/{workerUserName}"</span><span class="o">).</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"day"</span><span class="o">,</span> <span class="n">date</span><span class="o">).</span><span class="na">build</span><span class="o">(</span><span class="n">workerUserName</span><span class="o">)).</span><span class="na">retrieve</span><span class="o">()</span>
      <span class="o">.</span><span class="na">bodyToFlux</span><span class="o">(</span><span class="nc">WorklogInfo</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">collectList</span><span class="o">().</span><span class="na">block</span><span class="o">();</span>

    <span class="kt">int</span> <span class="n">totalDuration</span> <span class="o">=</span> <span class="n">worklogsForDay</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">mapToInt</span><span class="o">(</span><span class="nl">WorklogInfo:</span><span class="o">:</span><span class="n">getDuration</span><span class="o">).</span><span class="na">sum</span><span class="o">();</span>

    <span class="nc">DayStatusSummary</span> <span class="n">status</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DayStatusSummary</span><span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="n">workerUserName</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">totalDuration</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">status</span><span class="o">.</span><span class="na">addDayStatus</span><span class="o">(</span><span class="no">RIGHT_HOURS</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">totalDuration</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">status</span><span class="o">.</span><span class="na">addDayStatus</span><span class="o">(</span><span class="no">EXTRA_HOURS</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">status</span><span class="o">.</span><span class="na">addDayStatus</span><span class="o">(</span><span class="no">MISSING_HOURS</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="o">;</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>El <em>consumer</em> hace una petici√≥n a <code class="highlighter-rouge">/worklogs/worker/username?day=fecha</code> con un nombre de usuario y una fecha concretos y en base a los worklogs recibidos calcula el estado.</p>

<h5 id="producer--worklogcontrollerjava">Producer | WorklogController.java</h5>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/worklogs"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WorklogController</span> <span class="o">{</span>

  <span class="o">...</span>

  <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/worker/{workerUserName}"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Worklog</span><span class="o">&gt;</span> <span class="nf">getReportForWorkerAndDay</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"workerUserName"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">workerUserName</span><span class="o">,</span> 
                                                <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"day"</span><span class="o">)</span> <span class="nc">LocalDate</span> <span class="n">day</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">reportsService</span><span class="o">.</span><span class="na">getWorklogsForWorkerAndDay</span><span class="o">(</span><span class="n">workerUserName</span><span class="o">,</span> <span class="n">day</span><span class="o">);</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>El <em>producer</em> tiene un entry point para la url <code class="highlighter-rouge">/worklogs/worker/username?day=fecha</code> y hace una consulta a base de datos para recuperar los partes de horas del usuario en una fecha fecha y los devuelve.</p>

<p>Este c√≥digo al completo, as√≠ como el resto que utilicemos en los diferentes ejemplos est√° disponible en <a href="https://github.com/wearearima/time-report-contractTesting" target="_blank">Github</a>.</p>

<h2 id="back-to-testing">Back to testing</h2>

<p>Hasta aqu√≠ una peque√±a introducci√≥n o fotograf√≠a sobre la evoluci√≥n de arquitectura de las aplicaciones y una puesta en contexto para definir algunos conceptos que utilizaremos a lo largo del art√≠culo. Volvamos a lo que nos interesa: calidad y testing. ¬øC√≥mo testear√≠amos nuestra aplicaci√≥n? ¬øQu√© ‚Äúherramientas‚Äù de testing tenemos a nuestro alcance para testear una aplicaci√≥n de este tipo?</p>

<p>Como hemos dicho el <em>consumer</em> no deja de ser una aplicaci√≥n web que accede a otra aplicaci√≥n, que nos ofrece sus servicios mediante un API REST, el <em>producer</em>. Tenemos la mochila llena de herramientas y recursos que nos pueden servir para testear de forma estanca cada uno de estos dos componentes: test unitarios, tests de integraci√≥n, <a href="https://blog.arima.eu/en/2020/07/01/parameterized-tests.html" target="_blank">tests parametrizados</a>, JUnit 5, TestContainers, Mockito, <a href="https://blog.arima.eu/en/2020/05/25/mutation-testing.html" target="_blank">Pitest</a>‚Ä¶</p>

<p>Por ejemplo, en el <em>consumer</em> podr√≠amos testear los servicios que incluyen las llamadas al API REST mockeando/stubbeando las respuestas del servidor. Vamos a ver c√≥mo podr√≠a ser alguno de los tests que podr√≠amos tener.</p>

<h5 id="consumer--reportsservicewithmockwebservertestjava">Consumer | ReportsServiceWithMockWebServerTest.java</h5>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReportsServiceWithMockWebServerTest</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="kd">private</span> <span class="nc">MockWebServer</span> <span class="n">mockWebServer</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">ReportsService</span> <span class="n">reportsService</span><span class="o">;</span>

  <span class="nd">@BeforeEach</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mockWebServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockWebServer</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mockWebServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">reportsService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReportsService</span><span class="o">(</span><span class="nc">WebClient</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">mockWebServer</span><span class="o">.</span><span class="na">url</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">toString</span><span class="o">()).</span><span class="na">build</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"Given a worklog with 8 hours duration the status is RIGHT_HOURS"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">when_the_worklog_for_the_resquested_day_is_8_hours_the_status_is_RIGHT_HOURS</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">MockResponse</span> <span class="n">mockResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockResponse</span><span class="o">().</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"application/json; charset=utf-8"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="s">"[{\"fromTime\": \"08:30:00\", \"toTime\": \"16:30:00\"}]"</span><span class="o">);</span>
    <span class="n">mockWebServer</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">mockResponse</span><span class="o">);</span>

    <span class="nc">DayStatusSummary</span> <span class="n">result</span> <span class="o">=</span> <span class="n">reportsService</span><span class="o">.</span><span class="na">getDayStatusSummaryForWorkerAndDay</span><span class="o">(</span><span class="no">USERNAME</span><span class="o">,</span> <span class="no">DAY</span><span class="o">);</span>

    <span class="n">assertWebClientRequestEquals</span><span class="o">(</span><span class="s">"/worklogs/worker/"</span> <span class="o">+</span> <span class="no">USERNAME</span> <span class="o">+</span> <span class="s">"?day="</span> <span class="o">+</span> <span class="no">DAY</span><span class="o">);</span>
    <span class="n">assertStatusEquals</span><span class="o">(</span><span class="no">RIGHT_HOURS</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>

  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"Given a list of worklogs with 5,1,1 hours duration the status is MISSING_HOURS"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">when_the_worklogs_for_resquested_day_are_5_1_1_hours_the_status_is_MISSING_HOURS</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">MockResponse</span> <span class="n">mockResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockResponse</span><span class="o">().</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"application/json; charset=utf-8"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="s">"[{\"fromTime\": \"08:30:00\", \"toTime\": \"13:30:00\"},"</span>
                <span class="o">+</span> <span class="s">"{\"fromTime\": \"14:30:00\", \"toTime\": \"15:30:00\"},"</span>
                <span class="o">+</span> <span class="s">"{\"fromTime\": \"15:30:00\", \"toTime\": \"16:30:00\"}]"</span><span class="o">);</span>
    <span class="n">mockWebServer</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">mockResponse</span><span class="o">);</span>

    <span class="nc">DayStatusSummary</span> <span class="n">result</span> <span class="o">=</span> <span class="n">reportsService</span><span class="o">.</span><span class="na">getDayStatusSummaryForWorkerAndDay</span><span class="o">(</span><span class="no">USERNAME</span><span class="o">,</span> <span class="no">DAY</span><span class="o">);</span>

    <span class="n">assertWebClientRequestEquals</span><span class="o">(</span><span class="s">"/worklogs/worker/"</span> <span class="o">+</span> <span class="no">USERNAME</span> <span class="o">+</span> <span class="s">"?day="</span> <span class="o">+</span> <span class="no">DAY</span><span class="o">);</span>
    <span class="n">assertStatusEquals</span><span class="o">(</span><span class="no">MISSING_HOURS</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>

  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Este no es m√°s que un ejemplo de test que podr√≠amos hacer. Hemos aprovechado el ejemplo para probar <a href="https://github.com/square/okhttp/tree/master/mockwebserver" target="_blank">MockWebServer</a>, pero podr√≠amos haber mockeado directamente Webclient o utilizar alguna de las otras alternativas que existen como <a href="http://wiremock.org/" target="_blank">Wiremock</a>, <a href="https://www.testcontainers.org/modules/mockserver/" target="_blank">TestContainers</a>‚Ä¶. (en un futuro no muy lejano seguro que nos volvemos a encontrar con ellas ;)).</p>

<p>En el <em>producer</em> podr√≠amos testear el API REST tambi√©n mediante las herramientas que nos ofrece SpringBoot. Ve√°moslo tambi√©n mediante un ejemplo.</p>

<h5 id="producer--worklogcontrollermockedtestsjava">Producer | WorklogControllerMockedTests.java</h5>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebMvcTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WorklogControllerMockedTests</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">LocalDate</span> <span class="no">DAY</span> <span class="o">=</span> <span class="nc">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">USERNAME</span> <span class="o">=</span> <span class="s">"USU"</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CORRECT_URL</span> <span class="o">=</span> <span class="s">"/worklogs/worker/"</span> <span class="o">+</span> <span class="no">USERNAME</span> <span class="o">+</span> <span class="s">"?day="</span> <span class="o">+</span> <span class="no">DAY</span><span class="o">;</span>

  <span class="nd">@MockBean</span>
  <span class="nc">WorklogServiceImpl</span> <span class="n">worklogService</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">MockMvc</span> <span class="n">mvc</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"It returns a list with existing worklogs for requested worker and day"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">worklog_list_for_existing_user</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">Worklog</span> <span class="n">worklog1</span> <span class="o">=</span> <span class="n">createWorklogWithDescription</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"Description"</span><span class="o">);</span>
    <span class="nc">Worklog</span> <span class="n">worklog2</span> <span class="o">=</span> <span class="n">createWorklogWithDescription</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"Another description"</span><span class="o">);</span>
    <span class="n">when</span><span class="o">(</span><span class="n">worklogService</span><span class="o">.</span><span class="na">getWorklogsForWorkerAndDay</span><span class="o">(</span><span class="no">USERNAME</span><span class="o">,</span> <span class="no">DAY</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">worklog1</span><span class="o">,</span> <span class="n">worklog2</span><span class="o">));</span>

    <span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="no">CORRECT_URL</span><span class="o">).</span><span class="na">contentType</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)).</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$"</span><span class="o">,</span> <span class="n">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">))).</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[0].id"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="n">worklog1</span><span class="o">.</span><span class="na">getId</span><span class="o">())))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[0].description"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="s">"Description"</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[0].day"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="no">DAY</span><span class="o">.</span><span class="na">toString</span><span class="o">())))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[1].id"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="n">worklog2</span><span class="o">.</span><span class="na">getId</span><span class="o">())))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[1].description"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="s">"Another description"</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[1].day"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="no">DAY</span><span class="o">.</span><span class="na">toString</span><span class="o">())));</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"When the user doesn't have worklogs it returns an empty list"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">no_worklogs_for_user</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="n">when</span><span class="o">(</span><span class="n">worklogService</span><span class="o">.</span><span class="na">getWorklogsForWorkerAndDay</span><span class="o">(</span><span class="no">USERNAME</span><span class="o">,</span> <span class="no">DAY</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">emptyList</span><span class="o">());</span>

    <span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="no">CORRECT_URL</span><span class="o">).</span><span class="na">contentType</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)).</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$"</span><span class="o">,</span> <span class="n">hasSize</span><span class="o">(</span><span class="mi">0</span><span class="o">)));</span>

  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"When no date is request it returns status 400"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">response_400_for_request_with_no_date</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/worklogs/worker/"</span> <span class="o">+</span> <span class="no">USERNAME</span><span class="o">).</span><span class="na">contentType</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isBadRequest</span><span class="o">());</span>

	<span class="o">}</span>

  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Con estos (y otros tests) podr√≠amos tener un <em>consumer</em> y un <em>producer</em> bien testeados, pero nos falta una parte importante: asegurar que juntos funcionan correctamente. ¬øQu√© suceder√≠a si hay un cambio en el <em>producer</em>? Supongamos algo tan sencillo como el cambio del nombre de un par√°metro (por ejemplo en lugar de <strong>day</strong> que se renombrase a <strong>date</strong>).</p>

<h5 id="producer--worklogcontrollerjava-1">Producer | WorklogController.java</h5>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@RestController</span>
@RequestMapping("/worklogs")
<span class="p">public class WorklogController {
</span>
  ...

  @GetMapping("/worker/{workerUserName}")
  public List&lt;Worklog&gt; getReportForWorkerAndDay(
                       @PathVariable("workerUserName") String workerUserName, 
<span class="gd">-                      @RequestParam("day") LocalDate day) {
</span><span class="gi">+                      @RequestParam("date") LocalDate day) {    
</span>    return reportsService.getWorklogsForWorkerAndDay(workerUserName, day);
  }

}
</code></pre></div></div>

<p>Corregir√≠amos los tests que fuese necesario de nuestro <em>producer</em>.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@WebMvcTest</span>
public class WorklogControllerMockedTests {

  private static final LocalDate DAY = LocalDate.now();
  private static final String USERNAME = "USU";

-  private static final String CORRECT_URL = "/worklogs/worker/" + USERNAME + "?day=" + DAY;
<span class="gi">+  private static final String CORRECT_URL = "/worklogs/worker/" + USERNAME + "?date=" + DAY;
</span>    ...
<span class="err">}</span>
</code></pre></div></div>

<p>Y ¬°perfecto! los tests seguir√°n funcionando tanto en un componente como en el otro.</p>

<p>Pru√©balo tu mismo. Descarga el <a href="https://github.com/wearearima/time-report-contractTesting" target="_blank">c√≥digo</a> y haz las modificaciones anteriores. Ver√°s que los tests vuelven a funcionar correctamente tanto en el <em>consumer</em> como en el <em>producer</em>.
Pero prueba algo m√°s‚Ä¶ pon en marcha la aplicaci√≥n y prueba a <a href="http://localhost:8080/reports/report-worker-day" target="_blank">solicitar el informe para un usuario y una fecha</a> desde la aplicaci√≥n. ¬°Ups! Error. La aplicaci√≥n falla. ¬øEsto qu√© quiere decir?, que ¬°s√≥lo seremos capaces de detectar que algo se ha roto cuando la aplicaci√≥n falle üò± ! Demasiado tarde, ¬øno crees? üòñ</p>

<p>Es obvio que esto debemos evitarlo, ¬øpodemos? Si volvemos a revisar nuestra mochila (a la que me gusta llamar <em>testing toolbox</em>) encontramos los tests funcionales o test end-to-end. Si a todo lo anterior, a√±adimos unos tests de este tipo ya tendr√≠amos testeada la integraci√≥n de todo el sistema y ser√≠amos capaces de detectar el problema anterior antes de llegar a producci√≥n.</p>

<p>Aunque esta es una soluci√≥n, la realidad nos hace ver que este tipo de tests no son sencillos de realizar/mantener porque son m√°s complejos, porque nos obligan a tener <em>consumer</em> y <em>producer</em> en marcha (con lo que conlleva la puesta en marcha de todo el sistema) o incluso porque nos obliga a tener 100% implementadas las funcionalidades en ambos componentes para poder realizar las pruebas. Y eso en este ejemplo que es sencillo, en uno m√°s complejo‚Ä¶ Entonces, ¬øno hay alguna forma de simplificar el testeo de la comunicaci√≥n entre <em>consumer-producer</em>? La l√≥gica de negocio de cada uno de ellos est√° testeada de forma estanca, por lo tanto, en realidad ser√≠a necesario (y suficiente) asegurarnos que ambos cumplen una especificaci√≥n concreta‚Ä¶ verificar que existe un <strong>acuerdo</strong> entre <em>consumer</em> y <em>producer</em> y que ambos lo cumplen, nada m√°s (y nada menos). ¬øTenemos algo que nos ayude en este prop√≥sito? ¬°C√≥mo no! Tenemos una herramienta cuyo objetivo es este, su nombre <strong>Contract Testing</strong>. En breve publicaremos un nuevo post con un ejemplo pr√°ctico, stay tuned!</p>

            </div>

            
          </div>
        </article>
      </div>
    </main>

    <footer>
    <div class="wrapper">
        <div class="footer__container">
            <div class="footer__sello">
                <img src="/assets/images/arima_sello_white.png" alt="" />
            </div>
            <div class="footer__content">
                <div class="footer__data">
                    <dl>
                        <dt>web</dt>
                        <dd><a itemprop="sameAs" href="https://www.arima.eu/en/">arima.eu</a></dd>
                    </dl>
                    <dl>
                        <dt>social</dt>
                        <dd>
                            <a itemprop="sameAs" href="https://github.com/wearearima" class="social"><span class="icon-github"></span></a>
                            <a itemprop="sameAs" href="https://twitter.com/wearearima" class="social"><span class="icon-twitter"></span></a>
                            <a itemprop="sameAs" href="https://www.linkedin.com/company/arima-software-design/" class="social"><span class="icon-linkedin"></span></a>
                            <a itemprop="sameAs" href="/en/feed.xml" class="social"><span class="icon-feed"></span></a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>Privacy</dt>
                        <dd class="politica-cookies">
                            <a href="/en/cookies.html">Cookies Policy</a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</footer>
    <div class="cookies-message" id="cookies-message">
    <h4>This website uses cookies</h4>
    <p>This website uses cookies to improve user experience. By continuing to browse this website, you agree to the use of cookies as stated in our Cookies Policy.</p>
    <div class="buttons">
        <a class="button" href="/en/cookies.html">Read Cookies Policy</a>
        <button class="button" id="accept-cookies">Accept</button>
    </div>
</div>
<script>
    (function() {
        if(localStorage) {
            var cookiesAccepted = localStorage.getItem("cookies-accepted");
            if(cookiesAccepted) {
                hideCookiesMessage();
                
            } else {
                document.getElementById('accept-cookies').addEventListener("click", function() {
                    hideCookiesMessage();
                    localStorage.setItem("cookies-accepted", true);
                })
            }
        }
        function hideCookiesMessage() {
            document.getElementById('cookies-message').style.display = "none";
        }
    })();
</script>

  </body>

</html>