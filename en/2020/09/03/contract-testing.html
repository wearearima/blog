<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Blog">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Introduction to Contract Testing, setting the context </title>
  <meta name="description" content="Application development has evolved, and therefore new needs have arisen when it comes to testing and new tools to deal with them. Let’s take a look!">
  
  <meta name="keywords" content="testing,calidad,softwarequality,QA,contracttesting,consumer-drivencontract,consumerdrivencontract">
  

  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@wearearima">
  <meta name="twitter:creator" content="@jessica">
  <meta name="twitter:title"   content="Introduction to Contract Testing, setting the context ">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary_large_image">
  <meta name="twitter:image" content="https://blog.arima.eu/assets/images/2020-09-03-contract-testing/header_recortado.png">
  
  <!-- end of Twitter cards -->

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.arima.eu/en/2020/09/03/contract-testing.html">
  <link rel="alternate" type="application/rss+xml" title="ARIMA" href="/en/feed.xml">

  <!-- SEO Recipes (http://polyglot.untra.io/seo/) -->
  <meta http-equiv="Content-Language" content="en">
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/en/2020/09/03/contract-testing.html" />
  
  
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/es/2020/09/03/contract-testing.html" />
  
  
  <link rel="alternate"
      hreflang="en"
      href="https://blog.arima.eu/en/2020/09/03/contract-testing.html" />
  
  
  <link rel="alternate"
      hreflang="eu"
      href="https://blog.arima.eu/en/eus/2020/09/03/contract-testing.html" />
  

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120217722-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120217722-1');
</script>
  
</head>
  

  <body>
    <nav class="toolbar">
    <div class="wrapper">    
        <a href="/en/">
            <div class="toolbar__logo">
                <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" width="100%" height="100%" viewBox="0 0 33 6">
    <path id="path24" d="m30.346988508615652,-0.000015174522529526127 l-0.6439224998849951,0 l-2.7763635316117727,6.135695064030662 l0.7050150612484405,0 l2.3859233880279893,-5.335002838884215 l2.3660424189063254,5.335002838884215 l0.739668694925785,0 L30.346988508615652,-0.000015174522529526127 zm-8.274141805179609,3.3681675186951847 l-2.2194202716340565,-3.324608867598761 l-0.6962481061149294,0 l0,6.092136412934239 l0.6700853029999622,0 l0,-4.926062349034439 l2.2194202716340565,3.2553706313868567 l0.034929758248478535,0 l2.2192131782057056,-3.2639304930920168 l0,4.934622210739599 l0.6873430886958508,0 l0,-6.092136412934239 l-0.6961100438293623,0 l-2.2192131782057056,3.324608867598761 zm-9.143036799396208,-1.5057072863948877 c0,-1.0964906719739773 -0.8613705996531913,-1.8189015812038738 -2.201748299081466,-1.8189015812038738 l-2.619662837493104,0 l0,6.092136412934239 l0.6876192132669849,0 l0,-5.456842805897188 l1.8799251114245357,0 c0.9833486289517317,0 1.5576187057681203,0.4525681720889824 1.5576187057681203,1.2097017461390067 c0,0.7919252700129356 -0.7831583148794242,1.2620273523689407 -1.6968545207625496,1.2620273523689407 l0,0.6178287279128115 l1.7665759749739396,2.3672849794764295 l0.8442508762428699,0 l-1.8711581562910244,-2.4891249464894027 c0.9571858258367647,-0.17416557324290774 1.6534339319516944,-0.7659695603263191 1.6534339319516944,-1.7841098852409623 m2.7743616284710493,4.273234831730365 l0.6872050264102838,0 l0,-6.0920673817914555 l-0.6872050264102838,0 l0,6.0920673817914555 zM2.7761571742923965,-0.000015174522529526127 l-2.7761564381834223,6.135695064030662 l0.7048769989628736,0 l2.386061450313556,-5.335002838884215 l2.3658353254779745,5.335002838884215 l0.739668694925785,0 l-2.7761564381834223,-6.135695064030662 l-0.6441295933133457,0 z" stroke-width="0"/>
</svg>

            </div>
        </a>
        <!-- Language selector -->
        <div class="language-selector">
            
              
                <a class="unselected" href="/es/2020/09/03/contract-testing.html">ES</a>
              
              
                &nbsp;|&nbsp;
              
            
              
                <b class="selected">EN</b>
              
              
                &nbsp;|&nbsp;
              
            
              
                <a class="unselected" href="/eu/2020/09/03/contract-testing.html">EU</a>
              
              
            
         </div>
    </div>
</nav>
<div id="publisher_id" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Arima 100% Software Design" />
    <meta itemprop="url" content="https://arima.eu" />
    <div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content="https://arima.eu/img/logo.png" />
    </div>
</div>
    <main aria-label="Content">        
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting" itemref="publisher_id">
          <link itemprop="mainEntityOfPage" href="/en/2020/09/03/contract-testing.html" />

          <header class="post-header">
            <div class="post-img" itemprop="image" itemscope itemtype="http://schema.org/ImageObject" style="background-image: url('https://blog.arima.eu/assets/images/2020-09-03-contract-testing/header_recortado.png');">
              <meta itemprop="url" content="https://blog.arima.eu/assets/images/2020-09-03-contract-testing/header_recortado.png" />
            </div>
            <div class="wrapper">
              <div class="post-info__container">
                <div class="post-info">
                  <h1 class="post-title" itemprop="name headline">Introduction to Contract Testing, setting the context </h1>
                    <div class="post-meta" itemscope itemtype="https://schema.org/Person" itemprop="author">
                      
                      <div class="author-photo">
                        <img itemprop="image" src="/assets/images/authors/jessica.png" alt="">
                      </div>
                      <div>
                        <span class="post-author" itemprop="name">Jessica Aguado</span>
                      </div>
                      <div>
                        <span class="post-date">09-03-2020</span>
                      </div>
                    </div>
                    <meta  itemprop="datePublished dateModified" content="09-03-2020" />
                </div>
              </div>
            </div>
          </header>
          <div class="wrapper">
            <div class="post-content" itemprop="articleBody">
              <p>Application development has evolved, and therefore new needs have arisen when it comes to testing and new tools to deal with them. Let’s take a look!</p>

<p>We have gone from having monolithic architectures to applications based on (micro) services. Why do I say (micro) services instead of microservices? Because although the literature talks about the evolution of development from monolithic applications to applications based on microservices, in reality we often find ourselves with the integration of services (as is, without the need for them to be micro). The concept at hand applies equally well to the concept of microservices as it does to services, so from here on we will simplify using the term services.</p>

<p>Let’s imagine an application for managing worklogs, tasks, worklog reports…. The scheme of this said service-based application could be reflected in the following scheme.</p>

<p><img src="/assets/images/2020-09-03-contract-testing/01_schema_apps.jpg" alt="Example for service based applicactions scheme" class="center" /></p>

<p>The example shown in the previous image is quite simple. We would have two applications (one for the generation of reports and another for managing tasks and worklogs) and both would have on one side their implementation of a web application and their mobile application. The 4 services would consume a common service in charge of the overall management of tasks and worklogs. We could have more complex examples, where a service consumes another that in turn is consumed by a third party, etc. but in order to better understand the concept, instead of adding complexity, we are going to simplify it even more by zooming in on the previous image.</p>

<p><img src="/assets/images/2020-09-03-contract-testing/02_schema_app_simplificado.jpg" alt="Zoom of a portion of the scheme" class="center" /></p>

<p>As shown in the image, we have reduced the example to a web application that is responsible for making work log reports and that accesses a REST API to obtain information. We are going to establish the terminology that we will use from here on:</p>
<ul>
  <li><strong>CONSUMER</strong>: We will refer to the web application or equivalent service in its role of consuming another service</li>
  <li><strong>PRODUCER</strong>: With this term we will refer to the REST API or equivalent service in its role of offering its functionality.</li>
</ul>

<p>Having clarified these two concepts, we’ll make the most of using <strong>SERVICE</strong> to refer to each one of the functionalities offered by the <em>producer</em>.</p>

<p>Let’s see some possible code snippets of each:</p>

<h5 id="consumer--reportsservicejava">Consumer | ReportsService.java</h5>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReportsService</span> <span class="o">{</span>

  <span class="o">...</span>

  <span class="kd">public</span> <span class="nc">DayStatusSummary</span> <span class="nf">getDayStatusSummaryForWorkerAndDay</span><span class="o">(</span><span class="nc">String</span> <span class="n">workerUserName</span><span class="o">,</span> <span class="nc">LocalDate</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// retrieve worklogs for worker and day</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">WorklogInfo</span><span class="o">&gt;</span> <span class="n">worklogsForDay</span> <span class="o">=</span> <span class="n">webClient</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="n">uriBuilder</span> <span class="o">-&gt;</span> <span class="n">uriBuilder</span>
      <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">"/worklogs/worker/{workerUserName}"</span><span class="o">).</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"day"</span><span class="o">,</span> <span class="n">date</span><span class="o">).</span><span class="na">build</span><span class="o">(</span><span class="n">workerUserName</span><span class="o">)).</span><span class="na">retrieve</span><span class="o">()</span>
      <span class="o">.</span><span class="na">bodyToFlux</span><span class="o">(</span><span class="nc">WorklogInfo</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">collectList</span><span class="o">().</span><span class="na">block</span><span class="o">();</span>

    <span class="kt">int</span> <span class="n">totalDuration</span> <span class="o">=</span> <span class="n">worklogsForDay</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">mapToInt</span><span class="o">(</span><span class="nl">WorklogInfo:</span><span class="o">:</span><span class="n">getDuration</span><span class="o">).</span><span class="na">sum</span><span class="o">();</span>

    <span class="nc">DayStatusSummary</span> <span class="n">status</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DayStatusSummary</span><span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="n">workerUserName</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">totalDuration</span> <span class="o">==</span> <span class="mi">8</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">status</span><span class="o">.</span><span class="na">addDayStatus</span><span class="o">(</span><span class="no">RIGHT_HOURS</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">totalDuration</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">status</span><span class="o">.</span><span class="na">addDayStatus</span><span class="o">(</span><span class="no">EXTRA_HOURS</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">status</span><span class="o">.</span><span class="na">addDayStatus</span><span class="o">(</span><span class="no">MISSING_HOURS</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">status</span><span class="o">;</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>The <em>consumer</em> makes a request to <code class="highlighter-rouge">/worklogs/worker/username?day=date</code> with a specific username and date and calculates the status based on the worklogs received.</p>

<h5 id="producer--worklogcontrollerjava">Producer | WorklogController.java</h5>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/worklogs"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WorklogController</span> <span class="o">{</span>

  <span class="o">...</span>

  <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/worker/{workerUserName}"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Worklog</span><span class="o">&gt;</span> <span class="nf">getReportForWorkerAndDay</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"workerUserName"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">workerUserName</span><span class="o">,</span> 
                                                <span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"day"</span><span class="o">)</span> <span class="nc">LocalDate</span> <span class="n">day</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">reportsService</span><span class="o">.</span><span class="na">getWorklogsForWorkerAndDay</span><span class="o">(</span><span class="n">workerUserName</span><span class="o">,</span> <span class="n">day</span><span class="o">);</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>The <em>producer</em> has an entry point for the url <code class="highlighter-rouge">/worklogs/worker/username?day=date</code> and makes a database query to retrieve the user’s worklogs on a specific date and returns them.</p>

<p>This complete code, as well as the rest that we use in the different examples, is available at <a href="https://github.com/wearearima/time-report-contractTesting" target="_blank">Github</a>.</p>

<h2 id="back-to-testing">Back to testing</h2>

<p>So far then, a little introduction or snapshot of the evolution of application architecture and a context to define some concepts that we will use throughout the article. Now let’s go back to what interests us: quality and testing. How would we test our application? What testing “tools” do we have at our disposal to test an application of this type?</p>

<p>As we have said, the <em>consumer</em> remains a web application that accesses another application, which offers us its services through a REST API, the <em>producer</em>. We have a backpack full of tools and resources that can help us to test each of these two components in a watertight way: unit tests, integration tests, parameterized tests, JUnit 5, TestContainers, Mockito, <a href="https://blog.arima.eu/en/2020/05/25/mutation-testing.html" target="_blank">Pitest</a>…</p>

<p>For example, in the <em>consumer</em> we could test the services that include the calls to the REST API by mocking/stubbing the responses from the server. Let’s see what some of those tests might look like.</p>

<h5 id="consumer--reportsservicewithmockwebservertestjava">Consumer | ReportsServiceWithMockWebServerTest.java</h5>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReportsServiceWithMockWebServerTest</span> <span class="o">{</span>
  <span class="o">...</span>

  <span class="kd">private</span> <span class="nc">MockWebServer</span> <span class="n">mockWebServer</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">ReportsService</span> <span class="n">reportsService</span><span class="o">;</span>

  <span class="nd">@BeforeEach</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mockWebServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockWebServer</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">mockWebServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">reportsService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReportsService</span><span class="o">(</span><span class="nc">WebClient</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">baseUrl</span><span class="o">(</span><span class="n">mockWebServer</span><span class="o">.</span><span class="na">url</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">toString</span><span class="o">()).</span><span class="na">build</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"Given a worklog with 8 hours duration the status is RIGHT_HOURS"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">when_the_worklog_for_the_resquested_day_is_8_hours_the_status_is_RIGHT_HOURS</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">MockResponse</span> <span class="n">mockResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockResponse</span><span class="o">().</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"application/json; charset=utf-8"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="s">"[{\"fromTime\": \"08:30:00\", \"toTime\": \"16:30:00\"}]"</span><span class="o">);</span>
    <span class="n">mockWebServer</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">mockResponse</span><span class="o">);</span>

    <span class="nc">DayStatusSummary</span> <span class="n">result</span> <span class="o">=</span> <span class="n">reportsService</span><span class="o">.</span><span class="na">getDayStatusSummaryForWorkerAndDay</span><span class="o">(</span><span class="no">USERNAME</span><span class="o">,</span> <span class="no">DAY</span><span class="o">);</span>

    <span class="n">assertWebClientRequestEquals</span><span class="o">(</span><span class="s">"/worklogs/worker/"</span> <span class="o">+</span> <span class="no">USERNAME</span> <span class="o">+</span> <span class="s">"?day="</span> <span class="o">+</span> <span class="no">DAY</span><span class="o">);</span>
    <span class="n">assertStatusEquals</span><span class="o">(</span><span class="no">RIGHT_HOURS</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>

  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"Given a list of worklogs with 5,1,1 hours duration the status is MISSING_HOURS"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">when_the_worklogs_for_resquested_day_are_5_1_1_hours_the_status_is_MISSING_HOURS</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="nc">MockResponse</span> <span class="n">mockResponse</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MockResponse</span><span class="o">().</span><span class="na">addHeader</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">,</span> <span class="s">"application/json; charset=utf-8"</span><span class="o">)</span>
        <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="s">"[{\"fromTime\": \"08:30:00\", \"toTime\": \"13:30:00\"},"</span>
                <span class="o">+</span> <span class="s">"{\"fromTime\": \"14:30:00\", \"toTime\": \"15:30:00\"},"</span>
                <span class="o">+</span> <span class="s">"{\"fromTime\": \"15:30:00\", \"toTime\": \"16:30:00\"}]"</span><span class="o">);</span>
    <span class="n">mockWebServer</span><span class="o">.</span><span class="na">enqueue</span><span class="o">(</span><span class="n">mockResponse</span><span class="o">);</span>

    <span class="nc">DayStatusSummary</span> <span class="n">result</span> <span class="o">=</span> <span class="n">reportsService</span><span class="o">.</span><span class="na">getDayStatusSummaryForWorkerAndDay</span><span class="o">(</span><span class="no">USERNAME</span><span class="o">,</span> <span class="no">DAY</span><span class="o">);</span>

    <span class="n">assertWebClientRequestEquals</span><span class="o">(</span><span class="s">"/worklogs/worker/"</span> <span class="o">+</span> <span class="no">USERNAME</span> <span class="o">+</span> <span class="s">"?day="</span> <span class="o">+</span> <span class="no">DAY</span><span class="o">);</span>
    <span class="n">assertStatusEquals</span><span class="o">(</span><span class="no">MISSING_HOURS</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>

  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>This is just an example of a test that we could do. We have used the example to test <a href="https://github.com/square/okhttp/tree/master/mockwebserver" target="_blank">MockWebServer</a>, but we could have directly mocked Webclient or used one of the other alternatives which exist such as <a href="http://wiremock.org/" target="_blank">Wiremock</a>, <a href="https://www.testcontainers.org/modules/mockserver/" target="_blank">TestContainers</a>….(in the not too distant future we’ll meet them again for sure ;)).</p>

<p>In the <em>producer</em> we could also test the REST API using the tools offered by SpringBoot. Let’s look at it too through an example.</p>

<h5 id="producer--worklogcontrollermockedtestsjava">Producer | WorklogControllerMockedTests.java</h5>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebMvcTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WorklogControllerMockedTests</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">LocalDate</span> <span class="no">DAY</span> <span class="o">=</span> <span class="nc">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">USERNAME</span> <span class="o">=</span> <span class="s">"USU"</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">CORRECT_URL</span> <span class="o">=</span> <span class="s">"/worklogs/worker/"</span> <span class="o">+</span> <span class="no">USERNAME</span> <span class="o">+</span> <span class="s">"?day="</span> <span class="o">+</span> <span class="no">DAY</span><span class="o">;</span>

  <span class="nd">@MockBean</span>
  <span class="nc">WorklogServiceImpl</span> <span class="n">worklogService</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">MockMvc</span> <span class="n">mvc</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"It returns a list with existing worklogs for requested worker and day"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">worklog_list_for_existing_user</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="nc">Worklog</span> <span class="n">worklog1</span> <span class="o">=</span> <span class="n">createWorklogWithDescription</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"Description"</span><span class="o">);</span>
    <span class="nc">Worklog</span> <span class="n">worklog2</span> <span class="o">=</span> <span class="n">createWorklogWithDescription</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"Another description"</span><span class="o">);</span>
    <span class="n">when</span><span class="o">(</span><span class="n">worklogService</span><span class="o">.</span><span class="na">getWorklogsForWorkerAndDay</span><span class="o">(</span><span class="no">USERNAME</span><span class="o">,</span> <span class="no">DAY</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">worklog1</span><span class="o">,</span> <span class="n">worklog2</span><span class="o">));</span>

    <span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="no">CORRECT_URL</span><span class="o">).</span><span class="na">contentType</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)).</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$"</span><span class="o">,</span> <span class="n">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">))).</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[0].id"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="n">worklog1</span><span class="o">.</span><span class="na">getId</span><span class="o">())))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[0].description"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="s">"Description"</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[0].day"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="no">DAY</span><span class="o">.</span><span class="na">toString</span><span class="o">())))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[1].id"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="n">worklog2</span><span class="o">.</span><span class="na">getId</span><span class="o">())))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[1].description"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="s">"Another description"</span><span class="o">)))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$[1].day"</span><span class="o">,</span> <span class="n">is</span><span class="o">(</span><span class="no">DAY</span><span class="o">.</span><span class="na">toString</span><span class="o">())));</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"When the user doesn't have worklogs it returns an empty list"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">no_worklogs_for_user</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="n">when</span><span class="o">(</span><span class="n">worklogService</span><span class="o">.</span><span class="na">getWorklogsForWorkerAndDay</span><span class="o">(</span><span class="no">USERNAME</span><span class="o">,</span> <span class="no">DAY</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">emptyList</span><span class="o">());</span>

    <span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="no">CORRECT_URL</span><span class="o">).</span><span class="na">contentType</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">)).</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isOk</span><span class="o">())</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">jsonPath</span><span class="o">(</span><span class="s">"$"</span><span class="o">,</span> <span class="n">hasSize</span><span class="o">(</span><span class="mi">0</span><span class="o">)));</span>

  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"When no date is requested it returns status 400"</span><span class="o">)</span>
  <span class="kt">void</span> <span class="nf">response_400_for_request_with_no_date</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

    <span class="n">mvc</span><span class="o">.</span><span class="na">perform</span><span class="o">(</span><span class="n">get</span><span class="o">(</span><span class="s">"/worklogs/worker/"</span> <span class="o">+</span> <span class="no">USERNAME</span><span class="o">).</span><span class="na">contentType</span><span class="o">(</span><span class="no">APPLICATION_JSON</span><span class="o">))</span>
        <span class="o">.</span><span class="na">andExpect</span><span class="o">(</span><span class="n">status</span><span class="o">().</span><span class="na">isBadRequest</span><span class="o">());</span>

	<span class="o">}</span>

  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<p>With these (and other tests) we could have a well-tested <em>consumer</em> and <em>producer</em>, but we are missing an important part: ensuring that they work together correctly. What might happen if there were a change in the <em>producer</em>? Let’s suppose something as simple as changing the name of a parameter (for example, instead of <strong>day</strong> it is renamed <strong>date</strong>).</p>

<h5 id="producer--worklogcontrollerjava-1">Producer | WorklogController.java</h5>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@RestController</span>
@RequestMapping("/worklogs")
<span class="p">public class WorklogController {
</span>
  ...

  @GetMapping("/worker/{workerUserName}")
  public List&lt;Worklog&gt; getReportForWorkerAndDay(
                       @PathVariable("workerUserName") String workerUserName, 
<span class="gd">-                      @RequestParam("day") LocalDate day) {
</span><span class="gi">+                      @RequestParam("date") LocalDate day) {    
</span>    return reportsService.getWorklogsForWorkerAndDay(workerUserName, day);
  }

}
</code></pre></div></div>

<p>We would make the necessary corrections to the tests for our <em>producer</em>.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@WebMvcTest</span>
public class WorklogControllerMockedTests {

  private static final LocalDate DAY = LocalDate.now();
  private static final String USERNAME = "USU";

-  private static final String CORRECT_URL = "/worklogs/worker/" + USERNAME + "?day=" + DAY;
<span class="gi">+  private static final String CORRECT_URL = "/worklogs/worker/" + USERNAME + "?date=" + DAY;
</span>    ...
<span class="err">}</span>
</code></pre></div></div>

<p>And perfect! the tests will continue to work on one component as well as the other.</p>

<p>Try it yourself. Download the <a href="https://github.com/wearearima/time-report-contractTesting" target="_blank">code</a> and make the above modifications. You will see that the tests again work correctly in both the <em>consumer</em> and <em>producer</em>.
But try something else… start the application and try <a href="http://localhost:8080/reports/report-worker-day" target="_blank">request the report for a user and a date</a> from the application. Whoops! Error. The application crashes. What does this mean? That we will only be able to detect that something has broken when the application crashes 😱 ? Too late, don’t you think? 😖</p>

<p>It is obvious that we must avoid this, but can we? If we go back to look in our backpack (which I like to call <em>testing toolbox</em>) we find the functional tests or end-to-end tests. If we had added some of these tests to all of the above, then we would have tested the integration of the entire system and we would be able to detect the previous problem before reaching production.</p>

<p>Although this is a solution, reality shows us that this type of test is not easy to carry out/maintain because it is more complex, forcing us to have <em>consumer</em> and <em>producer</em> running (which entails the start-up of the entire system) or it forces us to have 100% implemented the functionalities in both components to be able to carry out the tests. And while that’s simple in this example, in a more complex one… So, isn’t there some way of simplifying the communication test between <em>consumer-producer</em>? The business logic of each of them is tested in a watertight manner, therefore, it would actually be necessary (and sufficient) to ensure that both meet a particular specification… to verify that there is an <strong>agreement</strong> between <em>consumer</em> and <em>producer</em> and that both keep to it, nothing more (and nothing less). Do we have anything to help us do this? Of course! We have a tool whose objective is just this, called <strong>Contract Testing</strong>. Soon we will publish a new post with a practical example. Stay tuned!</p>

            </div>

            
          </div>
        </article>
      </div>
    </main>

    <footer>
    <div class="wrapper">
        <div class="footer__container">
            <div class="footer__sello">
                <img src="/assets/images/arima_sello_white.png" alt="" />
            </div>
            <div class="footer__content">
                <div class="footer__data">
                    <dl>
                        <dt>web</dt>
                        <dd><a itemprop="sameAs" href="https://www.arima.eu/en/">arima.eu</a></dd>
                    </dl>
                    <dl>
                        <dt>social</dt>
                        <dd>
                            <a itemprop="sameAs" href="https://github.com/wearearima" class="social"><span class="icon-github"></span></a>
                            <a itemprop="sameAs" href="https://twitter.com/wearearima" class="social"><span class="icon-twitter"></span></a>
                            <a itemprop="sameAs" href="https://www.linkedin.com/company/arima-software-design/" class="social"><span class="icon-linkedin"></span></a>
                            <a itemprop="sameAs" href="/en/feed.xml" class="social"><span class="icon-feed"></span></a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>Privacy</dt>
                        <dd class="politica-cookies">
                            <a href="/en/cookies.html">Cookies Policy</a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</footer>
    <div class="cookies-message" id="cookies-message">
    <h4>This website uses cookies</h4>
    <p>This website uses cookies to improve user experience. By continuing to browse this website, you agree to the use of cookies as stated in our Cookies Policy.</p>
    <div class="buttons">
        <a class="button" href="/en/cookies.html">Read Cookies Policy</a>
        <button class="button" id="accept-cookies">Accept</button>
    </div>
</div>
<script>
    (function() {
        if(localStorage) {
            var cookiesAccepted = localStorage.getItem("cookies-accepted");
            if(cookiesAccepted) {
                hideCookiesMessage();
                
            } else {
                document.getElementById('accept-cookies').addEventListener("click", function() {
                    hideCookiesMessage();
                    localStorage.setItem("cookies-accepted", true);
                })
            }
        }
        function hideCookiesMessage() {
            document.getElementById('cookies-message').style.display = "none";
        }
    })();
</script>

  </body>

</html>