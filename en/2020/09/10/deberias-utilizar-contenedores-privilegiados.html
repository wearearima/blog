<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/Blog">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Should you use privileged containers?</title>
  <meta name="description" content="When working with containers it is important to always keep in mind the security of the container, or more importantly, of the machine that runs it. A bad de...">
  
  <meta name="keywords" content="docker">
  

  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@wearearima">
  <meta name="twitter:creator" content="@urko">
  <meta name="twitter:title"   content="Should you use privileged containers?">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary_large_image">
  <meta name="twitter:image" content="https://blog.arima.eu/assets/images/2020-09-10-deberias-utilizar-contenedores-privilegiados/lock.jpg">
  
  <!-- end of Twitter cards -->

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.arima.eu/en/2020/09/10/deberias-utilizar-contenedores-privilegiados.html">
  <link rel="alternate" type="application/rss+xml" title="ARIMA" href="/en/feed.xml">

  <!-- SEO Recipes (http://polyglot.untra.io/seo/) -->
  <meta http-equiv="Content-Language" content="en">
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/en/2020/09/10/deberias-utilizar-contenedores-privilegiados.html" />
  
  
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/es/2020/09/10/deberias-utilizar-contenedores-privilegiados.html" />
  
  
  <link rel="alternate"
      hreflang="en"
      href="https://blog.arima.eu/en/2020/09/10/deberias-utilizar-contenedores-privilegiados.html" />
  

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120217722-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120217722-1');
</script>
  
</head>

  <body>
    <nav class="toolbar">
    <div class="wrapper">    
        <a href="/en/">
            <div class="toolbar__logo">
                <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" width="100%" height="100%" viewBox="0 0 33 6">
    <path id="path24" d="m30.346988508615652,-0.000015174522529526127 l-0.6439224998849951,0 l-2.7763635316117727,6.135695064030662 l0.7050150612484405,0 l2.3859233880279893,-5.335002838884215 l2.3660424189063254,5.335002838884215 l0.739668694925785,0 L30.346988508615652,-0.000015174522529526127 zm-8.274141805179609,3.3681675186951847 l-2.2194202716340565,-3.324608867598761 l-0.6962481061149294,0 l0,6.092136412934239 l0.6700853029999622,0 l0,-4.926062349034439 l2.2194202716340565,3.2553706313868567 l0.034929758248478535,0 l2.2192131782057056,-3.2639304930920168 l0,4.934622210739599 l0.6873430886958508,0 l0,-6.092136412934239 l-0.6961100438293623,0 l-2.2192131782057056,3.324608867598761 zm-9.143036799396208,-1.5057072863948877 c0,-1.0964906719739773 -0.8613705996531913,-1.8189015812038738 -2.201748299081466,-1.8189015812038738 l-2.619662837493104,0 l0,6.092136412934239 l0.6876192132669849,0 l0,-5.456842805897188 l1.8799251114245357,0 c0.9833486289517317,0 1.5576187057681203,0.4525681720889824 1.5576187057681203,1.2097017461390067 c0,0.7919252700129356 -0.7831583148794242,1.2620273523689407 -1.6968545207625496,1.2620273523689407 l0,0.6178287279128115 l1.7665759749739396,2.3672849794764295 l0.8442508762428699,0 l-1.8711581562910244,-2.4891249464894027 c0.9571858258367647,-0.17416557324290774 1.6534339319516944,-0.7659695603263191 1.6534339319516944,-1.7841098852409623 m2.7743616284710493,4.273234831730365 l0.6872050264102838,0 l0,-6.0920673817914555 l-0.6872050264102838,0 l0,6.0920673817914555 zM2.7761571742923965,-0.000015174522529526127 l-2.7761564381834223,6.135695064030662 l0.7048769989628736,0 l2.386061450313556,-5.335002838884215 l2.3658353254779745,5.335002838884215 l0.739668694925785,0 l-2.7761564381834223,-6.135695064030662 l-0.6441295933133457,0 z" stroke-width="0"/>
</svg>

            </div>
        </a>
        <!-- Language selector -->
        <div class="language-selector">
            
              
                <a class="unselected" href="/es/2020/09/10/deberias-utilizar-contenedores-privilegiados.html">ES</a>
              
              
                &nbsp;|&nbsp;
              
            
              
                <b class="selected">EN</b>
              
              
            
         </div>
    </div>
</nav>
<div id="publisher_id" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Arima 100% Software Design" />
    <meta itemprop="url" content="https://arima.eu" />
    <div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content="https://arima.eu/img/logo.png" />
    </div>
</div>
    <main aria-label="Content">        
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting" itemref="publisher_id">
          <link itemprop="mainEntityOfPage" href="/en/2020/09/10/deberias-utilizar-contenedores-privilegiados.html" />

          <header class="post-header">
            <div class="post-img" itemprop="image" itemscope itemtype="http://schema.org/ImageObject" style="background-image: url('https://blog.arima.eu/assets/images/2020-09-10-deberias-utilizar-contenedores-privilegiados/lock.jpg');">
              <meta itemprop="url" content="https://blog.arima.eu/assets/images/2020-09-10-deberias-utilizar-contenedores-privilegiados/lock.jpg" />
            </div>
            <div class="wrapper">
              <div class="post-info__container">
                <div class="post-info">
                  <h1 class="post-title" itemprop="name headline">Should you use privileged containers?</h1>
                    <div class="post-meta" itemscope itemtype="https://schema.org/Person" itemprop="author">
                      
                      <div class="author-photo">
                        <img itemprop="image" src="/assets/images/authors/urko.png" alt="">
                      </div>
                      <div>
                        <span class="post-author" itemprop="name">Urko Lekuona</span>
                      </div>
                      <div>
                        <span class="post-date">10 Sep 2020</span>
                      </div>
                    </div>
                    <meta  itemprop="datePublished dateModified" content="10 Sep 2020" />
                </div>
              </div>
            </div>
          </header>
          <div class="wrapper">
            <div class="post-content" itemprop="articleBody">
              <p>When working with containers it is important to always keep in mind the security of the container, or more importantly, of the machine that runs it. A bad decision to deploy a container can grant you full access to the host, and this can have negative consequences if this container has a malicious purpose or if an unauthorized person gains access to it.</p>

<p>When reading about good practices to follow when running containers, one of the most common recommendations is: “<em>Do not run the container in privileged mode and give it only the capabilities it needs, if possible none</em>”. It is a good recommendation, but some questions arise:</p>
<ul>
  <li>What is privileged mode?</li>
  <li>Why is it not recommended to use it and what is it possible to do with a privileged container?</li>
  <li>Is it necessary to be a privileged user (<em>root</em>) or is any user inside a privileged container dangerous?</li>
  <li>Is there a way to prevent privileged containers from running?</li>
</ul>

<h2 id="what-is-privileged-mode">What is privileged mode?</h2>

<p>Containers start with a number of Linux capabilities by default. In addition to the ones that come by default, there are many others that can be added to our container with the <code class="highlighter-rouge">--cap-add =</code> option. The full list of capabilities and what they do can be seen in the <a href="https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities" target="_blank">official documentation</a>. By starting the container in privileged mode, it is granted all capabilities, as well as access to all devices on the host and certain changes are made to AppArmor or SELinux in order to give the container similar access to those the other processes on the host have.</p>
<p align="center">
    <img src="/assets/images/2020-09-10-deberias-utilizar-contenedores-privilegiados/no-devices.png" />
</p>

<p><label style="text-align: center; display: block;">List of devices in a container</label></p>

<p align="center">
    <img src="/assets/images/2020-09-10-deberias-utilizar-contenedores-privilegiados/devices.png" />
</p>

<p><label style="text-align: center; display: block;">List of devices in a container <strong>in privileged mode</strong></label></p>

<h2 id="why-is-it-not-recommended-to-use-it-and-what-is-it-possible-to-do-with-a-privileged-container">Why is it not recommended to use it and what is it possible to do with a privileged container?</h2>

<p>By definition, a container must be isolated from the host where it is running. This implies that it must have a different directory tree, its own users and groups, its own devices … even the hardware resources of the machine may be different. This is so that a process running in a container does not know that a host exists, and that the container and its processes do not depend on the host.</p>

<p>By running a privileged container, we break this isolation, since the container gains access to the host’s resources and devices, and also has all possible permissions to use them. Among other things, this allows it to perform actions such as:</p>
<ul>
  <li>Modifying the host’s filesystem.</li>
  <li>Controlling host processes.</li>
  <li>Granting permissions for host resource allocation.</li>
</ul>

<h2 id="is-it-necessary-to-be-a-privileged-user-root-or-is-any-user-inside-a-privileged-container-dangerous">Is it necessary to be a privileged user (<em>root</em>) or is any user inside a privileged container dangerous?</h2>

<p>In principle, all the actions that we have listed require administrator privileges within the container for them to be carried out. This means that, in theory, a non-privileged user inside a privileged container is not able to break this isolation.</p>

<p>However, it is common to find images (and build them) where the default user is a privileged user (usually <em>root</em>). This is often the case due to the image creator’s ignorance, because the creator prefers to delegate the responsibility of modifying the user, or because the image needs to execute a process with a privileged user.</p>
<p align="center">
    <img src="/assets/images/2020-09-10-deberias-utilizar-contenedores-privilegiados/top5.png" height="420" />
</p>

<p><label style="text-align: center; display: block;">The five most popular images in Docker Hub have a privileged user by default</label></p>

<p>Additionally, vulnerabilities have also been found (<a href="https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html" target="_blank">CVE-2019-5736 detected in February 2019</a>) where an unprivileged user is able to exploit the capabilities of a privileged container and access the host. Although much less common than the case of privileged users, it is a risk to bear in mind, because if there has been one, then more could be detected.</p>

<h2 id="is-there-a-way-to-prevent-privileged-containers-from-running">Is there a way to prevent privileged containers from running?</h2>

<p>There are <em>plugins</em> installed in the Docker daemon that allow functionalities to be extended. For this specific case, we are interested in the <a href="https://docs.docker.com/engine/extend/plugins_authorization/" target="_blank"><em>authorization plugin</em>s</a>. As they say in the Docker documentation, the default authorization of <code class="highlighter-rouge">dockerd</code> is “all or nothing”, in other words, either you have access to the daemon and you can do anything, or you don’t have access to it at all.</p>

<blockquote>
  <p>Note: Docker daemon or <code class="highlighter-rouge">dockerd</code> is a process that runs on the host and is in charge of managing its containers.</p>
</blockquote>

<p>With authorization <em>plugin</em>s we have the freedom to define policies that allow us to regulate access in a granular way, giving permission, for example, to a specific user to perform certain actions that others cannot. And what does this have to do with the privileges of a container?</p>

<p>Well, each <em>plugin</em> works in a different way, but they all end up doing the same thing: they intercept the daemon’s API call and check if that call is allowed or not, depending on the policies we have defined. That means <strong>only calls that DO NOT attempt to run privileged containers will be executed</strong>.</p>

<p>To demonstrate, we have chosen the <em>plugin</em> <a href="https://github.com/open-policy-agent/opa-docker-authz" target="_blank">opa-docker-authz</a>, which in a simple and very visual way, lets us define this specific rule.</p>

<pre><code class="language-rego"> package docker.authz

 default allow = false

 allow {
     not deny
 }

 deny {
     privileged
 }

 privileged {
     input.Body.HostConfig.Privileged == true
 }
</code></pre>

<p>The <code class="highlighter-rouge">input</code> document corresponds to the body of the call made to the Docker API. So, if this body contains an attribute called <code class="highlighter-rouge">Body.HostConfig.Privileged</code> with value <code class="highlighter-rouge">true</code>, we will deny the call. This is just an example, but much more elaborate policies can be created for each specific case.</p>

<p>As we have seen before, the greatest security risk comes from allowing the use of privileged mode for containers, so with a <em>plugin</em> like this, we could secure our installation to a great extent.</p>

<h2 id="conclusions">Conclusions</h2>

<p><strong>Using a privileged user or giving a container Linux capabilities is never to be recommended</strong>. That said, there are times when there is no alternative, but we should try to grant the minimum number of possible priorities to a container, enough for it to fulfill its function and no more.</p>

<p>Privileged mode should be used for containers as little as possible, in closed environments where we know the people who are going to have access to that container and can trust them. Where there is a risk that a user we do not trust could access the container, we should discard privileged mode to prevent problems. If it is necessary to grant a user permissions to create containers, it is recommended to secure the host’s dockerd with an authorization plugin.</p>

            </div>

            
          </div>
        </article>
      </div>
    </main>

    <footer>
    <div class="wrapper">
        <div class="footer__container">
            <div class="footer__sello">
                <img src="/assets/images/arima_sello_white.png" alt="" />
            </div>
            <div class="footer__content">
                <div class="footer__data">
                    <dl>
                        <dt>web</dt>
                        <dd><a itemprop="sameAs" href="https://www.arima.eu/en/">arima.eu</a></dd>
                    </dl>
                    <dl>
                        <dt>social</dt>
                        <dd>
                            <a itemprop="sameAs" href="https://github.com/wearearima" class="social"><span class="icon-github"></span></a>
                            <a itemprop="sameAs" href="https://twitter.com/wearearima" class="social"><span class="icon-twitter"></span></a>
                            <a itemprop="sameAs" href="https://www.linkedin.com/company/arima-software-design/" class="social"><span class="icon-linkedin"></span></a>
                            <a itemprop="sameAs" href="/en/feed.xml" class="social"><span class="icon-feed"></span></a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>Privacy</dt>
                        <dd class="politica-cookies">
                            <a href="/en/cookies.html">Cookies Policy</a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</footer>
    <div class="cookies-message" id="cookies-message">
    <h4>This website uses cookies</h4>
    <p>This website uses cookies to improve user experience. By continuing to browse this website, you agree to the use of cookies as stated in our Cookies Policy.</p>
    <div class="buttons">
        <a class="button" href="/en/cookies.html">Read Cookies Policy</a>
        <button class="button" id="accept-cookies">Accept</button>
    </div>
</div>
<script>
    (function() {
        if(localStorage) {
            var cookiesAccepted = localStorage.getItem("cookies-accepted");
            if(cookiesAccepted) {
                hideCookiesMessage();
                
            } else {
                document.getElementById('accept-cookies').addEventListener("click", function() {
                    hideCookiesMessage();
                    localStorage.setItem("cookies-accepted", true);
                })
            }
        }
        function hideCookiesMessage() {
            document.getElementById('cookies-message').style.display = "none";
        }
    })();
</script>

  </body>

</html>