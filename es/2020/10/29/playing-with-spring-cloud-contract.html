<!DOCTYPE html>
<html lang="es" itemscope itemtype="http://schema.org/Blog">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Jugando con Spring Cloud Contract</title>
  <meta name="description" content="En un post anterior hemos visto cómo surgen nuevas necesidades en el ámbito del testing derivadas de la evolución de las arquitecturas de las aplicaciones.">
  
  <meta name="keywords" content="testing,calidad,softwarequality,QA,contracttesting,providerdrivencontracttesting,springcloudcontract">
  

  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@wearearima">
  <meta name="twitter:creator" content="@jessica">
  <meta name="twitter:title"   content="Jugando con Spring Cloud Contract">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary_large_image">
  <meta name="twitter:image" content="https://blog.arima.eu/assets/images/2020-10-15-playing-with-spring-cloud-contract/header.jpg">
  
  <!-- end of Twitter cards -->

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.arima.eu/es/2020/10/29/playing-with-spring-cloud-contract.html">
  <link rel="alternate" type="application/rss+xml" title="ARIMA" href="/es/feed.xml">

  <!-- SEO Recipes (http://polyglot.untra.io/seo/) -->
  <meta http-equiv="Content-Language" content="es">
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/es/2020/10/29/playing-with-spring-cloud-contract.html" />
  
  
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/es/2020/10/29/playing-with-spring-cloud-contract.html" />
  
  
  <link rel="alternate"
      hreflang="en"
      href="https://blog.arima.eu/en/2020/10/29/playing-with-spring-cloud-contract.html" />
  

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120217722-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-120217722-1');
</script>
  
</head>

  <body>
    <nav class="toolbar">
    <div class="wrapper">    
        <a href="/es/">
            <div class="toolbar__logo">
                <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" width="100%" height="100%" viewBox="0 0 33 6">
    <path id="path24" d="m30.346988508615652,-0.000015174522529526127 l-0.6439224998849951,0 l-2.7763635316117727,6.135695064030662 l0.7050150612484405,0 l2.3859233880279893,-5.335002838884215 l2.3660424189063254,5.335002838884215 l0.739668694925785,0 L30.346988508615652,-0.000015174522529526127 zm-8.274141805179609,3.3681675186951847 l-2.2194202716340565,-3.324608867598761 l-0.6962481061149294,0 l0,6.092136412934239 l0.6700853029999622,0 l0,-4.926062349034439 l2.2194202716340565,3.2553706313868567 l0.034929758248478535,0 l2.2192131782057056,-3.2639304930920168 l0,4.934622210739599 l0.6873430886958508,0 l0,-6.092136412934239 l-0.6961100438293623,0 l-2.2192131782057056,3.324608867598761 zm-9.143036799396208,-1.5057072863948877 c0,-1.0964906719739773 -0.8613705996531913,-1.8189015812038738 -2.201748299081466,-1.8189015812038738 l-2.619662837493104,0 l0,6.092136412934239 l0.6876192132669849,0 l0,-5.456842805897188 l1.8799251114245357,0 c0.9833486289517317,0 1.5576187057681203,0.4525681720889824 1.5576187057681203,1.2097017461390067 c0,0.7919252700129356 -0.7831583148794242,1.2620273523689407 -1.6968545207625496,1.2620273523689407 l0,0.6178287279128115 l1.7665759749739396,2.3672849794764295 l0.8442508762428699,0 l-1.8711581562910244,-2.4891249464894027 c0.9571858258367647,-0.17416557324290774 1.6534339319516944,-0.7659695603263191 1.6534339319516944,-1.7841098852409623 m2.7743616284710493,4.273234831730365 l0.6872050264102838,0 l0,-6.0920673817914555 l-0.6872050264102838,0 l0,6.0920673817914555 zM2.7761571742923965,-0.000015174522529526127 l-2.7761564381834223,6.135695064030662 l0.7048769989628736,0 l2.386061450313556,-5.335002838884215 l2.3658353254779745,5.335002838884215 l0.739668694925785,0 l-2.7761564381834223,-6.135695064030662 l-0.6441295933133457,0 z" stroke-width="0"/>
</svg>

            </div>
        </a>
        <!-- Language selector -->
        <div class="language-selector">
            
              
                <b class="selected">ES</b>
              
              
                &nbsp;|&nbsp;
              
            
              
                <a class="unselected" href="/en/2020/10/29/playing-with-spring-cloud-contract.html">EN</a>
              
              
            
         </div>
    </div>
</nav>
<div id="publisher_id" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Arima 100% Software Design" />
    <meta itemprop="url" content="https://arima.eu" />
    <div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content="https://arima.eu/img/logo.png" />
    </div>
</div>
    <main aria-label="Content">        
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting" itemref="publisher_id">
          <link itemprop="mainEntityOfPage" href="/es/2020/10/29/playing-with-spring-cloud-contract.html" />

          <header class="post-header">
            <div class="post-img" itemprop="image" itemscope itemtype="http://schema.org/ImageObject" style="background-image: url('https://blog.arima.eu/assets/images/2020-10-15-playing-with-spring-cloud-contract/header.jpg');">
              <meta itemprop="url" content="https://blog.arima.eu/assets/images/2020-10-15-playing-with-spring-cloud-contract/header.jpg" />
            </div>
            <div class="wrapper">
              <div class="post-info__container">
                <div class="post-info">
                  <h1 class="post-title" itemprop="name headline">Jugando con Spring Cloud Contract</h1>
                    <div class="post-meta" itemscope itemtype="https://schema.org/Person" itemprop="author">
                      
                      <div class="author-photo">
                        <img itemprop="image" src="/assets/images/authors/jessica.png" alt="">
                      </div>
                      <div>
                        <span class="post-author" itemprop="name">Jessica Aguado</span>
                      </div>
                      <div>
                        <span class="post-date">29 Oct 2020</span>
                      </div>
                    </div>
                    <meta  itemprop="datePublished dateModified" content="29 Oct 2020" />
                </div>
              </div>
            </div>
          </header>
          <div class="wrapper">
            <div class="post-content" itemprop="articleBody">
              <p>En un <a href="https://blog.arima.eu/es/2020/09/03/contract-testing.html" target="_blank">post anterior</a> hemos visto cómo surgen nuevas necesidades en el ámbito del testing derivadas de la evolución de las arquitecturas de las aplicaciones.</p>

<p>Mediante un ejemplo sencillo hemos asentado conceptos como <em>consumer</em>, <em>producer</em>, <em>servicio</em> y hemos puesto en evidencia que tan importante como testear las funcionalidades en <em>consumer</em> y <em>producer</em> de forma independiente lo es asegurar que la interacción entre ambos es correcta.</p>

<p>Hemos introducido el concepto de <strong>Contract Testing</strong>, en el que hemos profundizado en otro <a href="https://blog.arima.eu/es/2020/10/09/contract-testing-approach.html" target="_blank">post</a> lo que nos ha permitido conocer los diferentes enfoques y herramientas.</p>

<p>Ahora, con toda la información en nuestras manos es hora de materializar todas esas ideas en código. Lo haremos paso a paso, partiendo del ejemplo del primer post, cuyo código podemos descargar de <a href="https://github.com/wearearima/time-report-contractTesting" target="_blank">aquí</a>. Recordemos que con él pusimos en evidencia el problema que podríamos encontrarnos: una aplicación que falla en producción pese a tener todos los tests unitarios y de integración pasando.</p>

<p>Hemos elegido el enfoque <strong>producer driven</strong> y como herramienta utilizaremos <a href="https://spring.io/projects/spring-cloud-contract" target="_blank"><strong>Spring Cloud Contract</strong></a>. El código está disponible en <a href="https://github.com/wearearima/time-report-contractTesting-02" target="_blank">Github</a> ¡Vamos allá!</p>

<h1 id="1-definir-el-contrato">1. Definir el contrato</h1>

<p>Empezaremos definiendo el acuerdo: escribiremos la especificación que tienen que cumplir <em>consumer</em> y <em>producer</em> para que la comunicación funcione correctamente. En Spring Cloud Contract se utiliza el término <strong>contrato</strong>. Se puede definir de diferentes formas (groovy, yaml, java, kotlin), nosotros hemos elegido <code class="highlighter-rouge">yaml</code> porque para este ejemplo nos parecía que podría resultar fácil de leer.</p>

<p>Para nuestro caso de uso definimos el siguiente contrato:</p>

<h5 id="worklogsforworkeranddayyaml">worklogsForWorkerAndDay.yaml</h5>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">description</span><span class="pi">:</span> <span class="s">Given a worker's username and a day it returns the worklog info for that worker and day</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">worklogsForWokerAndDay_success</span>
<span class="na">request</span><span class="pi">:</span>
   <span class="na">urlPath</span><span class="pi">:</span> <span class="s">/worklogs/worker/JESSI</span>
   <span class="na">queryParameters</span><span class="pi">:</span>
      <span class="na">day</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2020-05-05"</span>
   <span class="na">method</span><span class="pi">:</span> <span class="s">GET</span>
   <span class="na">matchers</span><span class="pi">:</span>
    <span class="na">url</span><span class="pi">:</span>
      <span class="na">regex</span><span class="pi">:</span> <span class="s">/worklogs/worker/([a-zA-Z]*)</span>
    <span class="na">queryParameters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">key</span><span class="pi">:</span> <span class="s">day</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">matching</span>
        <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">(</span><span class="se">\\</span><span class="s">d</span><span class="se">\\</span><span class="s">d</span><span class="se">\\</span><span class="s">d</span><span class="se">\\</span><span class="s">d)-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])"</span>
<span class="na">response</span><span class="pi">:</span>
   <span class="na">status</span><span class="pi">:</span> <span class="m">200</span>
   <span class="na">headers</span><span class="pi">:</span>
      <span class="na">Content-Type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">application/json"</span>
   <span class="na">bodyFromFile</span><span class="pi">:</span> <span class="s">worklogsForJessiOn20200505Response.json</span>
</code></pre></div></div>

<p>En este caso estamos estableciendo el siguiente acuerdo:<br />
<em>Para una <strong>petición</strong> con: un nombre de usuario y una fecha (cuyo formato también especificamos), la <strong>respuesta</strong> será: <code class="highlighter-rouge">status 200</code> y un <code class="highlighter-rouge">JSON</code> (cuyo contenido establecemos mediante un <a href="https://github.com/wearearima/time-report-contractTesting-02/blob/master/timeReports-producer/src/test/resources/contracts/worklogs/worklogsForJessiOn20200505Response.json" target="_blank">fichero</a>).</em></p>

<p>Este contrato debe estar accesible para el <em>producer</em>. En este caso y por simplificar estará en la carpeta <code class="highlighter-rouge">/test/resources/contracts/worklogs</code> del <em>producer</em>.</p>

<p>Una vez que hemos definido el contrato tendremos que hacer la implementación que lo cumpla y los tests necesarios que lo verifiquen. En este ejemplo ya partíamos de la implementación, así que ¡vamos con los test!</p>

<h1 id="2-producer-configurar-las-dependencias-en-el-pomxml">2. Producer: configurar las dependencias en el pom.xml</h1>

<p>Modificamos el <code class="highlighter-rouge">pom.xml</code> para añadir la dependiencia de Spring Cloud Contract Verifier y el plugin <code class="highlighter-rouge">spring-cloud-contract-maven-plugin</code>. Con este último conseguiremos que de forma automática:</p>

<ul>
  <li>Se generen los tests que verifiquen que nuestro <em>producer</em> cumple el contrato</li>
  <li>Se cree un stub que permitirá al <em>consumer</em> generar un <a href="http://wiremock.org/" target="_blank">WireMock</a> (que cumplirá el contrato) contra el que ejecutar sus tests</li>
</ul>

<h4 id="producer--pomxml">Producer | pom.xml</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="nt">&lt;dependencies&gt;</span>
  ...
  <span class="c">&lt;!-- Spring Cloud Contract Verifier --&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-contract-verifier<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
...
<span class="nt">&lt;build&gt;</span>
  <span class="nt">&lt;plugins&gt;</span>
    ...
    <span class="nt">&lt;plugin&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-cloud-contract-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>3.0.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;extensions&gt;</span>true<span class="nt">&lt;/extensions&gt;</span>
      <span class="nt">&lt;configuration&gt;</span>
        <span class="nt">&lt;testFramework&gt;</span>JUNIT5<span class="nt">&lt;/testFramework&gt;</span>
        <span class="nt">&lt;packageWithBaseClasses&gt;</span>eu.arima.tr<span class="nt">&lt;/packageWithBaseClasses&gt;</span>
      <span class="nt">&lt;/configuration&gt;</span>
    <span class="nt">&lt;/plugin&gt;</span>
  <span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>

<span class="nt">&lt;dependencyManagement&gt;</span>
  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>${spring-cloud.version}<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
      <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/dependencyManagement&gt;</span>
...
</code></pre></div></div>

<p>Como se muestra en el <code class="highlighter-rouge">pom.xml</code>además de las dependencias hemos configurado algunas de las propiedades del plugin:</p>
<ul>
  <li>Hemos indicado que el framework de test será JUnit 5</li>
  <li>Hemos indicado que el paquete que contendrá la <em>clase base de test</em> será <code class="highlighter-rouge">eu.arima.tr</code></li>
</ul>

<p>¿Qué es esto de la <em>clase base de test</em>? Según la especificación debemos generar una clase base que los test autogenerados extenderán. Esta clase debe contener toda la información necesaria para ejecutarlos (por ejemplo, podríamos configurar mocks de algunos beans, popular la base de datos con datos específicos para los tests…).<br />
Para este ejemplo hemos creado una clase base muy sencilla cuya única responsabilidad será levantar el contexto. El contrato lo hemos definido en la carpeta <code class="highlighter-rouge">contracts/worklogs</code>, por lo tanto (en base a la documentación que indica que el nombre se infiere en base a los nombres de las dos últimas carpetas), la clase se llama <code class="highlighter-rouge">WorklogsBase.java</code>.</p>

<h4 id="producer--worklogsbasejava">Producer | WorklogsBase.java</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">eu</span><span class="o">.</span><span class="na">arima</span><span class="o">.</span><span class="na">tr</span><span class="o">;</span>

<span class="nd">@ExtendWith</span><span class="o">(</span><span class="nc">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">WorklogsBase</span> <span class="o">{</span>
  <span class="nd">@Autowired</span>
  <span class="nc">WebApplicationContext</span> <span class="n">context</span><span class="o">;</span>

  <span class="nd">@BeforeEach</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">RestAssuredMockMvc</span><span class="o">.</span><span class="na">webAppContextSetup</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">context</span><span class="o">);</span>
  <span class="o">}</span> 
<span class="o">}</span> 
</code></pre></div></div>

<p>El plugin admite la configuración de otros parámetros como se explica en la <a href="https://cloud.spring.io/spring-cloud-contract/spring-cloud-contract-maven-plugin/index.html" target="_blank">documentación del plugin</a>, como por ejemplo: dónde están los contratos, cómo generar los diferentes elementos, etc.</p>

<h1 id="3-producer-crear-y-ejecutar-los-tests">3. Producer: crear y ejecutar los tests</h1>

<p>Como mencionábamos en el apartado anterior, con este plugin podemos generar automáticamente los tests que aseguren que el <em>producer</em> cumple el conrato. Para ello hacemos <code class="highlighter-rouge">./mvnw clean test</code> y vemos que:</p>

<ul>
  <li>Se generan las clases de test del <em>producer</em></li>
  <li>Se ejecutan los tests</li>
  <li>Además se crea un <code class="highlighter-rouge">.jar</code> (que de momento dejamos aparcado)</li>
</ul>

<p>¿Cómo son los tests que se autogeneran? Están en la carpeta <code class="highlighter-rouge">generated-test-sources</code>. En este caso en concreto, como tenemos una única carpeta, se genera una única clase:</p>

<h4 id="producer--worklogstestjava">Producer | WorklogsTest.java</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">"rawtypes"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WorklogsTest</span> <span class="kd">extends</span> <span class="nc">WorklogsBase</span> <span class="o">{</span>

 <span class="nd">@Test</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate_worklogsForWokerAndDay_success</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="c1">// given:</span>
   <span class="nc">MockMvcRequestSpecification</span> <span class="n">request</span> <span class="o">=</span> <span class="n">given</span><span class="o">();</span>


  <span class="c1">// when:</span>
   <span class="nc">ResponseOptions</span> <span class="n">response</span> <span class="o">=</span> <span class="n">given</span><span class="o">().</span><span class="na">spec</span><span class="o">(</span><span class="n">request</span><span class="o">)</span>
     <span class="o">.</span><span class="na">queryParam</span><span class="o">(</span><span class="s">"day"</span><span class="o">,</span><span class="s">"2020-05-05"</span><span class="o">)</span>
     <span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"/worklogs/worker/JESSI"</span><span class="o">);</span>

  <span class="c1">// then:</span>
   <span class="n">assertThat</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">statusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
   <span class="n">assertThat</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Content-Type"</span><span class="o">)).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">);</span>

  <span class="c1">// and:</span>
   <span class="nc">DocumentContext</span> <span class="n">parsedJson</span> <span class="o">=</span> <span class="nc">JsonPath</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">().</span><span class="na">asString</span><span class="o">());</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['worker']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['worker']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['userName']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"JESSI"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['worker']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['new']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['task']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['task']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['name']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Daily meeting"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['task']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['new']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['day']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"2020-05-05"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['fromTime']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"08:30:00"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['toTime']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"09:30:00"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['description']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Daily meeting"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['new']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['task']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">field</span><span class="o">(</span><span class="s">"['task']"</span><span class="o">).</span><span class="na">field</span><span class="o">(</span><span class="s">"['name']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Implement the use case Create report for user and day"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['fromTime']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"09:30:00"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['toTime']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"16:30:00"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['description']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Create database and queries"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['id']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['toTime']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"11:00:00"</span><span class="o">);</span>
   <span class="n">assertThatJson</span><span class="o">(</span><span class="n">parsedJson</span><span class="o">).</span><span class="na">array</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"['description']"</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Create de frontend form for selecting user and date"</span><span class="o">);</span>
 <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>Como vemos hay un método de test para la definición del contrato. Si tuviésemos más de una, en ese caso tendríamos un test por cada uno de ellos.</p>

<p>En el test que se ha generado vemos como se hace un <code class="highlighter-rouge">assert</code> para comprobar que el <code class="highlighter-rouge">statusCode</code> de la response es el esperado. Además vemos cómo se verifica que el tipo de respuesta sea un <code class="highlighter-rouge">json</code> y cómo se ha parseado el fichero <code class="highlighter-rouge">.json</code> (al que hacíamos referencia en la especificación) para hacer los <code class="highlighter-rouge">assert</code>s necesarios que aseguran que la respuesta es la esperada.</p>

<p><strong>¿Y desde eclipse?</strong></p>

<p>Personalmente utilizo eclipse en mis desarrollos, así que me interesa poder ejecutarlos desde el IDE. Obviamente primero necesitamos que se generen, esto ya hemos visto cómo debemos hacerlo mediante <code class="highlighter-rouge">./mvnw clean test</code>. Pero si no he cambiado el contrato y no hace falta que se regeneren los test y además estoy desarrollando y quiero pasar todos los tests, ¿cómo lo hago? Como son clases autogeneradas, es necesario añadir las carpetas de <code class="highlighter-rouge">generated-test-sources</code> al buildpath. Por ejemplo, en este caso:</p>

<p><img src="/assets/images/2020-10-15-playing-with-spring-cloud-contract/buildpath_config.png" alt="Configuración del buildpath para ejecutar los tests desde eclipse" class="center" /></p>

<h1 id="4-consumer-configurar-las-dependencias">4. Consumer: configurar las dependencias</h1>

<p>A diferencia del <em>producer</em>, los tests en el <em>consumer</em> relacionados con el contrato no se generan de forma automática. Pero no estamos solos: recordemos que al mismo tiempo que se han creado los tests del <em>producer</em> también se ha generado un <code class="highlighter-rouge">.jar</code> con el stub que nos permitirá simular las llamadas al <em>producer</em> desde los tests del <em>consumer</em>.</p>

<p>En nuestro caso, el jar es: <code class="highlighter-rouge">timeReports-producer-0.0.1-SNAPSHOT-stubs.jar</code> que podemos encontrarlo en la carpeta <code class="highlighter-rouge">target </code>del <em>producer</em>.</p>

<p>En este caso, al tener ambos proyectos en local, si en lugar de hacer <code class="highlighter-rouge">./mvnw clean test</code> (en el <em>producer</em>) hacemos <code class="highlighter-rouge">./mvnw clean install</code> tendremos dicho jar directamente en nuestro repositorio local de maven, con lo cual, podremos configurar nuestro <em>consumer</em> para que acceda a él.</p>

<p>Para poder tener acceso a él añadimos la siguiente dependencia en el <code class="highlighter-rouge">pom.xml</code>:</p>

<h4 id="consumer--pomxml">Consumer | pom.xml</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
  <span class="nt">&lt;dependencies&gt;</span>
  ...
    <span class="c">&lt;!-- PRODUCER STUB --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>eu.arima.tr<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>timeReports-producer<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;classifier&gt;</span>stubs<span class="nt">&lt;/classifier&gt;</span>
        <span class="nt">&lt;version&gt;</span>0.0.1-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  ...
  <span class="nt">&lt;/dependencies&gt;</span>
...  
</code></pre></div></div>

<p>Además, no debemos olvidarnos de dependencia de Spring Cloud Contract para poder ejecutar el stub añadido.</p>

<h4 id="consumer--pomxml-1">Consumer | pom.xml</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
  <span class="nt">&lt;dependencies&gt;</span>
  ...
    <span class="c">&lt;!-- SPRING CLOUD CONTRACT --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-contract-stub-runner<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  ...
  <span class="nt">&lt;/dependencies&gt;</span>

  <span class="nt">&lt;dependencyManagement&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>${spring-cloud.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
   <span class="nt">&lt;/dependencies&gt;</span>
 <span class="nt">&lt;/dependencyManagement&gt;</span>
...  
</code></pre></div></div>

<h1 id="5-consumer-crear-y-ejecutar-los-tests">5. Consumer: crear y ejecutar los tests</h1>

<p>Una vez añadidas las dependencias ya podemos crear el WireMock basado en ese stub y crear nuestros tests. Nosotros lo haremos mediante la anotación <code class="highlighter-rouge">@AutoConfigureStubRunner</code> donde indicamos nuestro stub para que sea automáticamente descargado y registrado en el Wiremock. Un ejemplo podría ser:</p>

<h5 id="consumer--reportsservicecontracttestjava">Consumer | ReportsServiceContractTest.java</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ExtendWith</span><span class="o">(</span><span class="nc">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="nd">@AutoConfigureStubRunner</span><span class="o">(</span><span class="n">ids</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"eu.arima.tr:timeReports-producer:+:stubs:"</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReportsServiceContractTest</span> <span class="o">{</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">ReportsService</span> <span class="n">reportsService</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kt">void</span> <span class="nf">test_getDayStatusSummaryForWorkerAndDay</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">LocalDate</span> <span class="n">dateFromProducerTest</span> <span class="o">=</span> <span class="nc">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">workerFromProducerTest</span> <span class="o">=</span> <span class="s">"TestUser"</span><span class="o">;</span>
    <span class="nc">DayStatusSummary</span> <span class="n">result</span> <span class="o">=</span> <span class="n">reportsService</span><span class="o">.</span><span class="na">getDayStatusSummaryForWorkerAndDay</span><span class="o">(</span><span class="n">workerFromProducerTest</span><span class="o">,</span>
				<span class="n">dateFromProducerTest</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">workerFromProducerTest</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">getWorkerUserName</span><span class="o">());</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="n">dateFromProducerTest</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">getDate</span><span class="o">());</span>
  <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>Con esto ya tendríamos la comunicación entre ambos testeada, asegurándonos que si en algún momento en alguno de los dos componentes hubiese una modificación en el contrato los tests del otro fallarían. ¿Lo vemos?</p>

<h2 id="somos-capaces-de-desplegar-en-producción-con-la-certeza-de-que-todo-funciona">¿Somos capaces de desplegar en producción con la certeza de que todo funciona?</h2>

<p>Este era el problema que nos encontramos en el <a href="https://blog.arima.eu/es/2020/09/03/contract-testing.html" target="_blank">post anterior</a>: pese a tener testeados <em>consumer</em> y <em>producer</em>, no éramos capaces de saber que algo no iba bien hasta llegar a producción. ¿Seremos capaces de detectarlo ahora?</p>

<p>Supongamos, que realizamos el mismo cambio que proponíamos en aquel post:</p>

<h5 id="producer--worklogcontrollerjava">Producer | WorklogController.java</h5>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@RestController</span>
@RequestMapping("/worklogs")
<span class="p">public class WorklogController {
</span>
  ...

  @GetMapping("/worker/{workerUserName}")
  public List&lt;Worklog&gt; getReportForWorkerAndDay(
                       @PathVariable("workerUserName") String workerUserName, 
<span class="gd">-                      @RequestParam("day") LocalDate day) {
</span><span class="gi">+                      @RequestParam("date") LocalDate day) {    
</span>    return reportsService.getWorklogsForWorkerAndDay(workerUserName, day);
  }

}
</code></pre></div></div>

<p>Pasamos los tests y efectivamente fallan: tanto el unitario que tenemos como el autogenerado. ¿Y esto por qué? Porque en realidad hemos modificado el contrato. Actualizamos el contrato y corregimos los tests que fallan:</p>

<h5 id="worklogsforworkeranddayyaml-1">worklogsForWorkerAndDay.yaml</h5>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">request:
</span>   urlPath: /worklogs/worker/JESSI
   queryParameters:
<span class="gd">-      day: "2020-05-05"
</span><span class="gi">+      date: "2020-05-05"
</span>   method: GET
   matchers:
    url:
      regex: /worklogs/worker/([a-zA-Z]*)
    queryParameters:
<span class="gd">-      - key: day
</span><span class="gi">+      - key: date
</span>        type: matching
        value: "(\\d\\d\\d\\d)-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])"
</code></pre></div></div>

<p>Hacemos <code class="highlighter-rouge">./mvnw clean test</code> y ahora ya pasan todos nuestros tests. ¡Bien! Vemos cómo ha cambiado el test autogenerado.</p>

<h5 id="producer--worklogstestjava-1">Producer | WorklogsTest.java</h5>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">@Test</span>
public void validate_worklogsForWokerAndDay_success() throws Exception {
  // given:
  MockMvcRequestSpecification request = given();

  // when:
  ResponseOptions response = given().spec(request)
<span class="gd">-	      .queryParam("day","2020-05-05")
</span><span class="gi">+	      .queryParam("date","2020-05-05")
</span>        .get("/worklogs/worker/JESSI");
</code></pre></div></div>

<p>Como hemos cambiado el contrato debemos hacer llegar al <em>consumer</em> la actualización, así que hacemos <code class="highlighter-rouge">./mvnw clean install</code> en el <em>producer</em> y pasamos los tests del <em>consumer</em> con <code class="highlighter-rouge">./mvnw clean test</code>.</p>

<p>¿Qué sucede? Si bien los tests unitarios que teníamos siguen pasando correctamente, el nuevo test añadido falla: nos hace ver que algo ha cambiado en el contrato, así que la aplicación no va a funcionar. ¡Bien! <strong>Objetivo conseguido: hemos detectado el problema antes del despliegue en producción</strong>.</p>

<p>Modificamos la implementación del <em>consumer</em>:</p>

<h4 id="consumer--reportsservicejava">Consumer | ReportsService.java</h4>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">public DayStatusSummary getDayStatusSummaryForWorkerAndDay(String workerUserName, LocalDate date) {
</span>  // retrieve worklogs for worker and day
  List&lt;WorklogInfo&gt; worklogsForDay = webClient.get().uri(uriBuilder -&gt; uriBuilder
<span class="gd">-	    .path("/worklogs/worker/{workerUserName}").queryParam("day", date).build(workerUserName)).retrieve()
</span><span class="gi">+	    .path("/worklogs/worker/{workerUserName}").queryParam("date", date).build(workerUserName)).retrieve()
</span>      .bodyToFlux(WorklogInfo.class).collectList().block();

  int totalDuration = worklogsForDay.stream().mapToInt(WorklogInfo::getDuration).sum();
</code></pre></div></div>

<p>Pasamos los tests, y vemos que al cambiar la implementación los tests unitarios también han dejado de funcionar (lógicamente). Sólo nos quedará por lo tanto, corregirlos.</p>

<p>Como hemos visto en el ejemplo, es importante que cuando cambia el contrato tanto <em>consumer</em> como <em>producer</em> estén al tanto del cambio.</p>

<p>En este caso como es desde el <em>producer</em> desde donde se realiza el cambio, es importante que el <em>consumer</em> reciba la nueva especificación a través del stub (si no, los test seguirán pasando). En nuestro ejemplo es sencillo porque lo tenemos todo en local. Nos sirve para explicar el concepto de forma sencilla pero no nos olvidamos de que no refleja la realidad, donde muchas veces diferentes personas están trabajando en uno o en el otro sin necesidad de tener los proyectos en local.<br />
Existen muchas formas de organizar el código y por lo tanto existen diferentes soluciones, que habría que analizar en función del proyecto y sus necesidades. Las preguntas más importantes a las que habría que dar respuesta sería:</p>

<ul>
  <li><strong>¿Dónde ubicamos los contratos?</strong> ¿Podrían estar en el propio proyecto (como en el ejemplo) o quizás seríamejor que estuviesen en su propio repositorio de github?</li>
  <li><strong>¿Cómo gestionamos el stub del <em>producer</em>?</strong> ¿Podríamos desplegarlo en un repo de maven?</li>
  <li><strong>¿Cómo gestionamos el versionado?</strong> ¿Será el mismo que el del <em>producer</em> o será independiente?</li>
</ul>

<p>No vamos a entrar a valorar estas y otras muchas cosas, que habría que tener en cuenta a la hora de ponerlo en práctica porque la respuesta será <em>depende</em>. Depende del proyecto, de la organización de los equipos,… En la documentación de Spring Cloud Contract hay diferentes recomendaciones y ejemplos que pueden sernos de utilidad.</p>

            </div>

            
          </div>
        </article>
      </div>
    </main>

    <footer>
    <div class="wrapper">
        <div class="footer__container">
            <div class="footer__sello">
                <img src="/assets/images/arima_sello_white.png" alt="" />
            </div>
            <div class="footer__content">
                <div class="footer__data">
                    <dl>
                        <dt>web</dt>
                        <dd><a itemprop="sameAs" href="https://www.arima.eu/es/">arima.eu</a></dd>
                    </dl>
                    <dl>
                        <dt>social</dt>
                        <dd>
                            <a itemprop="sameAs" href="https://github.com/wearearima" class="social"><span class="icon-github"></span></a>
                            <a itemprop="sameAs" href="https://twitter.com/wearearima" class="social"><span class="icon-twitter"></span></a>
                            <a itemprop="sameAs" href="https://www.linkedin.com/company/arima-software-design/" class="social"><span class="icon-linkedin"></span></a>
                            <a itemprop="sameAs" href="/es/feed.xml" class="social"><span class="icon-feed"></span></a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>Privacidad</dt>
                        <dd class="politica-cookies">
                            <a href="/es/cookies.html">Política de cookies</a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</footer>
    <div class="cookies-message" id="cookies-message">
    <h4>Este sitio web utiliza cookies</h4>
    <p>Este sitio web utiliza cookies para mejorar la experiencia del usuario. Al utilizar nuestro sitio web, usted acepta todas las cookies de acuerdo con nuestra Política de cookies.</p>
    <div class="buttons">
        <a class="button" href="/es/cookies.html">Leer política de cookies</a>
        <button class="button" id="accept-cookies">Aceptar</button>
    </div>
</div>
<script>
    (function() {
        if(localStorage) {
            var cookiesAccepted = localStorage.getItem("cookies-accepted");
            if(cookiesAccepted) {
                hideCookiesMessage();
                
            } else {
                document.getElementById('accept-cookies').addEventListener("click", function() {
                    hideCookiesMessage();
                    localStorage.setItem("cookies-accepted", true);
                })
            }
        }
        function hideCookiesMessage() {
            document.getElementById('cookies-message').style.display = "none";
        }
    })();
</script>

  </body>

</html>