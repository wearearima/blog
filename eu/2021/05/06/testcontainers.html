<!DOCTYPE html>
<html lang="eu" itemscope itemtype="http://schema.org/Blog">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.googletagmanager.com https://www.google-analytics.com https://www.gstatic.com https://platform.twitter.com https://cdn.syndication.twimg.com https://syndication.twitter.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://www.google-analytics.com https://www.googletagmanager.com https://pbs.twimg.com https://ton.twimg.com https://abs.twimg.com; font-src 'self' data:; connect-src 'self' https://www.google-analytics.com https://www.googletagmanager.com https://stats.g.doubleclick.net https://region1.google-analytics.com https://platform.twitter.com https://cdn.syndication.twimg.com https://syndication.twitter.com; frame-src https://platform.twitter.com https://www.youtube.com; frame-ancestors 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; manifest-src 'self'; upgrade-insecure-requests;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="accelerometer=(), camera=(), geolocation=(), gyroscope=(), microphone=(), payment=(), usb=()">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">

  <title>Testcontainers: edukiontziak testing-aren zerbitzura</title>
  <meta name="description" content="Integrazio-testak baino gustokoago izan ditut beti unitate-testak, batez ere arrazoi honengatik: ez dut kanpoko ezer behar hauek pasa ahal izateko. Ez dut be...">
  
  <meta name="keywords" content="testing,calidad,softwarequality,QA,testContainers,testintegraci√≥n">
  

  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@wearearima">
  <meta name="twitter:creator" content="@jessica">
  <meta name="twitter:title"   content="Testcontainers: edukiontziak testing-aren zerbitzura">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary_large_image">
  <meta name="twitter:image" content="https://blog.arima.eu/assets/images/2021-05-06-testcontainers/header.jpg">
  
  <!-- end of Twitter cards -->

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.arima.eu/eu/2021/05/06/testcontainers.html">
  <link rel="alternate" type="application/rss+xml" title="ARIMA" href="/eu/feed.xml">

  <!-- SEO Recipes (http://polyglot.untra.io/seo/) -->
  <meta http-equiv="Content-Language" content="eus">
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/eu/2021/05/06/testcontainers.html" />
  
  
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/es/2021/05/06/testcontainers.html" />
  
  
  <link rel="alternate"
      hreflang="en"
      href="https://blog.arima.eu/en/2021/05/06/testcontainers.html" />
  
  
  <link rel="alternate"
      hreflang="eu"
      href="https://blog.arima.eu/eu/eus/2021/05/06/testcontainers.html" />
  

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120217722-1"></script>
<script defer src="/assets/google-analytics.js"></script>

  
</head>

  

  <body>
    <nav class="toolbar">
    <div class="wrapper">    
        <a href="/eu/">
            <div class="toolbar__logo">
                <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" width="100%" height="100%" viewBox="0 0 33 6">
    <path id="path24" d="m30.346988508615652,-0.000015174522529526127 l-0.6439224998849951,0 l-2.7763635316117727,6.135695064030662 l0.7050150612484405,0 l2.3859233880279893,-5.335002838884215 l2.3660424189063254,5.335002838884215 l0.739668694925785,0 L30.346988508615652,-0.000015174522529526127 zm-8.274141805179609,3.3681675186951847 l-2.2194202716340565,-3.324608867598761 l-0.6962481061149294,0 l0,6.092136412934239 l0.6700853029999622,0 l0,-4.926062349034439 l2.2194202716340565,3.2553706313868567 l0.034929758248478535,0 l2.2192131782057056,-3.2639304930920168 l0,4.934622210739599 l0.6873430886958508,0 l0,-6.092136412934239 l-0.6961100438293623,0 l-2.2192131782057056,3.324608867598761 zm-9.143036799396208,-1.5057072863948877 c0,-1.0964906719739773 -0.8613705996531913,-1.8189015812038738 -2.201748299081466,-1.8189015812038738 l-2.619662837493104,0 l0,6.092136412934239 l0.6876192132669849,0 l0,-5.456842805897188 l1.8799251114245357,0 c0.9833486289517317,0 1.5576187057681203,0.4525681720889824 1.5576187057681203,1.2097017461390067 c0,0.7919252700129356 -0.7831583148794242,1.2620273523689407 -1.6968545207625496,1.2620273523689407 l0,0.6178287279128115 l1.7665759749739396,2.3672849794764295 l0.8442508762428699,0 l-1.8711581562910244,-2.4891249464894027 c0.9571858258367647,-0.17416557324290774 1.6534339319516944,-0.7659695603263191 1.6534339319516944,-1.7841098852409623 m2.7743616284710493,4.273234831730365 l0.6872050264102838,0 l0,-6.0920673817914555 l-0.6872050264102838,0 l0,6.0920673817914555 zM2.7761571742923965,-0.000015174522529526127 l-2.7761564381834223,6.135695064030662 l0.7048769989628736,0 l2.386061450313556,-5.335002838884215 l2.3658353254779745,5.335002838884215 l0.739668694925785,0 l-2.7761564381834223,-6.135695064030662 l-0.6441295933133457,0 z" stroke-width="0"/>
</svg>

            </div>
        </a>
        <!-- Language selector -->
        <div class="language-selector">
            
              
                <a class="unselected" href="/es/2021/05/06/testcontainers.html">ES</a>
              
              
                &nbsp;|&nbsp;
              
            
              
                <a class="unselected" href="/en/2021/05/06/testcontainers.html">EN</a>
              
              
                &nbsp;|&nbsp;
              
            
              
                <b class="selected">EU</b>
              
              
            
         </div>
    </div>
</nav>
<div id="publisher_id" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Arima 100% Software Design" />
    <meta itemprop="url" content="https://arima.eu" />
    <div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content="https://arima.eu/img/logo.png" />
    </div>
</div>
    <main aria-label="Content">        
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting" itemref="publisher_id">
          <link itemprop="mainEntityOfPage" href="/eu/2021/05/06/testcontainers.html" />

          <header class="post-header">
            <div class="post-img" itemprop="image" itemscope itemtype="http://schema.org/ImageObject" style="background-image: url('https://blog.arima.eu/assets/images/2021-05-06-testcontainers/header.jpg');">
              <meta itemprop="url" content="https://blog.arima.eu/assets/images/2021-05-06-testcontainers/header.jpg" />
            </div>
            <div class="wrapper">
              <div class="post-info__container">
                <div class="post-info">
                  <h1 class="post-title" itemprop="name headline">Testcontainers: edukiontziak testing-aren zerbitzura</h1>
                    <div class="post-meta" itemscope itemtype="https://schema.org/Person" itemprop="author">
                      
                      <div class="author-photo">
                        <img itemprop="image" src="/assets/images/authors/jessica.png" alt="">
                      </div>
                      <div>
                        <span class="post-author" itemprop="name">Jessica Aguado</span>
                      </div>
                      <div>
                        <span class="post-date">2021-05-06</span>
                      </div>
                    </div>
                    <meta  itemprop="datePublished dateModified" content="2021-05-06" />
                </div>
              </div>
            </div>
          </header>
          <div class="wrapper">
            <div class="post-content" itemprop="articleBody">
              <p>Integrazio-testak baino gustokoago izan ditut beti unitate-testak, batez ere arrazoi honengatik: ez dut kanpoko ezer behar hauek pasa ahal izateko. Ez dut behar datu-base bat, kanpo-zerbitzu bat edo Kafka bat martxan izatea testak pasatu ahal izateko, eta ondorioz, garatu ahal izateko.
Eta hori garapen-inguruneari dagokionez, zeren eta integrazio-ingurunea hartzen badugu kontutan, hare gehiago.
Adibidez, datu-baseen kasuan, testak H2rekin egiteko aukera dugu. Baina kontutan eduki behar da proiektu motaren arabera, gerta daitekeela H2n primeran funtzionatzen duen zerbaitek, garatzen ari garen datu-basean ez funtzionatzea. <br />
Askotan</p>
<blockquote>
  <p>‚ÄúTira‚Ä¶ H2rekin egingo dugu, datu-basea martxan ez jartzeagatik‚Ä¶‚Äù</p>
</blockquote>

<p>pentsatu dugun bezain egia da beste egoera hau:</p>
<blockquote>
  <p>‚ÄúBaino‚Ä¶ testatuta dago! Orduan zergatik‚Ä¶? Ups‚Ä¶‚Äù</p>
</blockquote>

<p>Ni beti izan naiz dena instalatuta eduki behar duen horietakoa: MySQL, Postgres, Kafka‚Ä¶ Proiektua martxan jartzeko behar den guztia. Horrela, proiektuaren arabera, dena instalatuta eta zerbitzu guztiak martxan ditudala ziurtatu behar izan dut beti. Baina hau nire lankideek edukiontziak aurkeztu zizkidatenean bukatu zen, tira, Docker aurkeztu zizkidatenean.
Inoiz ez naiz izan oso trebea gauza hauekin,. Baina egia esan, hauei esker ez dut hamaika gauza instalatuta edukitzeko beharrik: behar ditudan zerbitzuen irudiak ditut, eta behar ditudanak martxan jarri besterik ez dut egin behar, eta kito.
Goazen harira. Egia da orain aplikazioak martxan jartzeko dena askoz ere antolatuago daukadala, baina egia esan, garatzerako orduan oraindik ere gutxi gorabehera berdin nago: integrazio-testak pasatu nahi baditut, datu-basea martxan jartzeaz gogoratu behar naiz (adibidez), beraz, oraindik ez da H2 bezain gardena.</p>

<p><small>Baten batek imajinatuko zuen bezala, honek guztiak ere badu CIn aplikazioa. Baina post honetan, tresna honek garatzailearen eguneroko lanean nola lagunduko digun jarriko dugu harreta.</small></p>

<blockquote>
  <p>‚ÄúBi munduak batzen dituen eta testak autosufizienteak egiten dituen zerbait egon behar du, benetako ingurune bat simulatuz‚Äù</p>
</blockquote>

<p>Ideia hori buruan nuela eta lankide batekin hitz egin ondoren, hala zela jakin nuen: ¬°<a href="https://www.testcontainers.org/" target="_blank"><strong>TestContainers</strong></a> izeneko zerbait existitzen da!</p>

<p>Adibidez, imajina ditzagun buruhausteak eragiten dizkigun eguneko egoera batzuk: kide berri bat taldean! edo, laguntza eskatu nahi badiogu lankide bati erabilera-kasu edo bug kasu bati buruz? edo, hilabetetan lanik egin ez dugun proiektu batetara itzultzen bagara?
Horrelako egoeren aurrean (eta beste batzuen aurrean), zenbat aldiz pentsatuko genuen ‚Äúez al da posible izango dena deskargatu, testak pasa eta garatzen hastea beste ezer egin gabe?‚Äù.
Denbora igaro da bakarrik ez negoela konturatu nintzela. <a href="https://twitter.com/kiview" target="_blank">@kiview</a>ren aurkezpen bat ikusten ari nintzela konturatu nintzen. Aurkezpenaren hasieran honelako zerbait esaten zuen:</p>
<blockquote>
  <p>‚Ä¶proiektu baten onboarding-esperientzia arrakastatsua ondorengoa izango litzateke: garatzaile batek proiektu baten biltegia klonatzea, buildinga egitea eta horrekin proiektua eraikita izatea, unitate eta integrazio-testak barne‚Ä¶</p>
</blockquote>

<p>Hau da, ondorengo pauso hauek jarraitzea:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; git clone https://github.com/wearearima/school-library-testcontainers-01.git
&gt; cd school-library-testcontainers-01
&gt; ./mvnw install
</code></pre></div></div>
<p>Eta listo!<br />
Begiek üòç egin zidaten. Hitzaldiaren izenburua <a href="https://www.youtube.com/watch?v=Lv1evJe2MRI" target="_blank">Integration Testing with Docker and Testcontiners</a> zen, hau da,  <strong>TestContainers</strong> hain zuzen. Berri onak orduan! Badirudi <strong>TestContainers</strong>ekin lan egiteak helburu horretara hurbiltzea errazten digula eta lana sinplifikatzen digula, garapen propioan zentratu ahal izateko (eta jakina, testetan ere).</p>

<h1 id="adibidea-database-container-postgres-module">Adibidea: Database container (Postgres Module)</h1>
<p>Horrela esanda, denak oso itxura ona du, baina (noizbehinka irakurtzen nauzuenok jakingo duzuenez) kontzeptuak ulertzeko praktikan jarri behar ditut, beraz, adibide bat prestatu dugu <a href="https://github.com/wearearima/school-library-testcontainers-01" target="_blank">Github</a>en. 
Ohikoena, seguruenik, datu-baseen aurka egiten ditugun testen egoera da, eta Testcontainersek datu-base desberdinetarako <em>moduloak</em> eskaintzen dizkigu. Horregatik, adibide sinple bat prestatu dugu, Postgres datu-base batera konektatzen den Spring Boot aplikazio batena.<br />
Gure adibidea:<br />
    <em>Demagun eskola bateko liburutegia. Jasotzen ditugun aleei alta ematen joateko balioko duen funtzionalitate bat dugu. Izan genezakeen metodoetako bat ‚Äúliburu baten kopia gehitzea‚Äù izan zitekeen (‚Äúliburua‚Äù kontzeptua dela ulertuta, eta ‚Äúkopia‚Äù, berriz, izan dezakegun ale bakoitzaren errepresentazioa).</em><br />
<small>Etorkizunean adibide hau eboluzionatzen eta kodea gehitzen joango gara.</small></p>

<p>Esan bezela,<a href="https://www.testcontainers.org/modules/databases/postgres/" target="_blank">Postgres</a>erako dagoen modulua erabiliko dugu. Kontainer hau erabiliz testak egitea oso erraza da, goazen ba!</p>

<h2 id="docker-instalatu">Docker instalatu</h2>
<p>Lehenik eta behin, <a href="https://www.docker.com/products/docker-desktop" target="_blank">Docker Desktop</a> instalatu behar dugu (eduki ezean). Ondoren, Docker instalatu ahal izateko behar diren eskakizunak azaltzen dituen dokumentazioaren esteka utziko dut: <a href="https://www.testcontainers.org/supported_docker_environment/" target="_blank">General Docker requirements</a>.</p>

<h2 id="gehitu-behar-diren-dependentziak">Gehitu behar diren dependentziak</h2>
<p>Kodearekin hasteko, lehenik eta behin, proiektuak behar dituen dependentziak gehitu beharko ditugu (gure kasuan, pom.xml-an).</p>

<p>Guk <a href="https://start.spring.io/" target="_blank">Spring Initializr</a> erabiliz sortu dugu proiektua eta bertan gehitu dugu dependentzia</p>

<p><img src="/assets/images/2021-05-06-testcontainers/spring-initializr.png" alt="Nola gehitu Testcontainers Spring Initializr erabiliz" class="center" /></p>

<p>Eskuz eginez gero, <a href="https://www.testcontainers.org/quickstart/junit_5_quickstart/#1-add-testcontainers-as-a-test-scoped-dependency" target="_blank">dokumentazioan</a> dependentziak nola gehitu zehazten da.</p>

<p>Gainera, Postgres modulua erabiliko dugunez, dependentzi hori ere gehituko dugu:</p>

<h4 id="pomxml">pom.xml</h4>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>postgresql<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>Eta Testcontainers erabiltzen ari ez bagina egingo genukeen bezala, Postgresen dependentzia ere gehituko dugu.</p>

<h4 id="pomxml-1">pom.xml</h4>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.postgresql<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>postgresql<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<h2 id="start-coding">Start coding!</h2>
<p>Listo! Gure erabilera-kasua inplementatu dezakegu. Test bat baino gehiago egingo dugu (hemen eskuragarri: <a href="https://github.com/wearearima/school-library-testcontainers-01/blob/master/src/test/java/eu/arima/schoolLibrary/bookStore/BooksServiceTest.java">Github</a>), baina hemen adibide gisa bakarra ikusiko dugu. Testak ondorengoa egingo du: lehendik existitzen den ISBN bati liburu baten kopia bat gehitzen diogunean, liburu horri kopia bat gehitu zaiola egiaztatuko dugu. Erraza, ezta?</p>

<h4 id="booksservicetestjava">BooksServiceTest.java</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="nd">@Transactional</span>
<span class="kd">class</span> <span class="nc">BooksServiceTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">BooksService</span> <span class="n">booksService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">BooksRepository</span> <span class="n">booksRepository</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">CopiesRepository</span> <span class="n">copiesRepository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="nd">@DisplayName</span><span class="o">(</span><span class="s">"addCopy for a book that exists with the provided isbn adds a new copy to it"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">addCopy_if_book_exist_adds_new_copy</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">isbn</span> <span class="o">=</span> <span class="s">"9780745168197"</span><span class="o">;</span>
        <span class="nc">Book</span> <span class="n">existingBook</span> <span class="o">=</span> <span class="n">booksRepository</span><span class="o">.</span><span class="na">findBookByIsbnEquals</span><span class="o">(</span><span class="n">isbn</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">existingNumCopies</span> <span class="o">=</span> <span class="n">existingBook</span><span class="o">.</span><span class="na">getCopies</span><span class="o">().</span><span class="na">size</span><span class="o">();</span>

        <span class="nc">Copy</span> <span class="n">createdCopy</span> <span class="o">=</span> <span class="n">booksService</span><span class="o">.</span><span class="na">addCopy</span><span class="o">(</span><span class="n">existingBook</span><span class="o">.</span><span class="na">getTitle</span><span class="o">(),</span> <span class="n">existingBook</span><span class="o">.</span><span class="na">getAuthors</span><span class="o">(),</span> <span class="n">isbn</span><span class="o">);</span>

        <span class="nc">Book</span> <span class="n">updatedBook</span> <span class="o">=</span> <span class="n">booksRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">existingBook</span><span class="o">.</span><span class="na">getId</span><span class="o">()).</span><span class="na">orElseThrow</span><span class="o">();</span>
        <span class="n">assertAll</span><span class="o">(</span>
                <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">assertEquals</span><span class="o">(</span><span class="n">existingNumCopies</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">updatedBook</span><span class="o">.</span><span class="na">getCopies</span><span class="o">().</span><span class="na">size</span><span class="o">()),</span>
                <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">assertRelationBetweenBookAndCopyIsCorrect</span><span class="o">(</span><span class="n">createdCopy</span><span class="o">,</span> <span class="n">updatedBook</span><span class="o">));</span>

    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>Baina testa besterik gabe exekutatzen badugu, ikusiko dugu kontextua altxatu ezin duelako huts egiten duela: datu-baseari buruzko informazioa falta zaio.
Egia da application.properties fitxategian jarri ditzakegula balioak‚Ä¶ baina horrek eskatuko luke iritsi berri den garatzaile horrek (edo zuk, adibidea deskargatuko duzunak) datu-basea altxatuko beharko lukeela‚Ä¶ Ez litzateke izango bilatzen dugun egoera ezin hobe hori. Soluzioa?</p>

<h3 id="testcontainers">@Testcontainers</h3>
<p>Hain zuzen, <code class="highlighter-rouge">@Testcontainers</code> anotazioa, lerro gutxi batzuk, eta listo:</p>

<h4 id="booksservicetestjava-1">BooksServiceTest.java</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="nd">@Transactional</span>
<span class="nd">@Testcontainers</span>
<span class="kd">class</span> <span class="nc">BooksServiceTest</span> <span class="o">{</span>

    <span class="nd">@Container</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">PostgreSQLContainer</span> <span class="n">postgresContainer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PostgreSQLContainer</span><span class="o">(</span><span class="nc">DockerImageName</span>
            <span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"postgres:13"</span><span class="o">));</span>

    <span class="nd">@DynamicPropertySource</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">databaseProperties</span><span class="o">(</span><span class="nc">DynamicPropertyRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.url"</span><span class="o">,</span> <span class="nl">postgresContainer:</span><span class="o">:</span><span class="n">getJdbcUrl</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.username"</span><span class="o">,</span> <span class="nl">postgresContainer:</span><span class="o">:</span><span class="n">getUsername</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.password"</span><span class="o">,</span> <span class="nl">postgresContainer:</span><span class="o">:</span><span class="n">getPassword</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<p>Zer egin dugu?</p>
<ul>
  <li><code class="highlighter-rouge">@Testcontainers</code> anotazioa erantsi diogu test klaseari.</li>
  <li>Postgres duen kontainer baten instantzia bat sortu dugu <code class="highlighter-rouge">@Container</code> anotazioa erabiliz eta bertsioa zehaztuz.</li>
  <li>Azkenik, datasourcearen datuak ezarri ditugu <code class="highlighter-rouge">@DynamicPropertySource</code> bidez, sortutako kontainerretik balioak hartuz.</li>
</ul>

<p>Ikus dezakezuenez, inplementazioa oso erraza da, eta onura berehalakoa: adibidea deskargatu eta zuen ekipoetan testak pasa dezakezue zuzenean, Docker instalatuta besterik eduki gabe (gogoratzen al dituzue lehengo 3 komandoak? Proba ditzakezue).</p>

<h3 id="singleton-patroia">Singleton patroia</h3>
<p>Badago hori guztia inplementatzeko beste modu bat, eraginkorragoa: Singleton eredua. Horrela, kontainer bera test klase batean baino gehiagotan erabili ahalko genuke.
Dokumentazioan hurbilketa hori egitea gomendatzen da hain zuzen. Test klase bakarra besterik ez dugun adibide honetan, ez dirudi erabilgarria. Baina seguruenik ez da gure proiektuaren funtzionalitate bakarra izango, ezta? Kasua hori izango balitz, orduan bai, Singleton eredura pasatuko ginateke, <a href="https://www.testcontainers.org/test_framework_integration/manual_lifecycle_control/#singleton-containers" target="_blank">hemen</a> azaltzen den bezala.</p>

<p>Ikus dezagun nolakoa izango litzatekeen:</p>

<h4 id="booksservicetestjava-2">BooksServiceTest.java</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootTest</span>
<span class="nd">@Transactional</span>
<span class="kd">class</span> <span class="nc">BooksServiceTest</span> <span class="kd">extends</span> <span class="nc">PostgresContainerBaseTest</span> <span class="o">{</span>
    <span class="c1">//@Container eta @DynamicPropertySource ez dira behar PostgresContainerBaseTest klasean ditugulako</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="postgrescontainerbasetestjava">PostgresContainerBaseTest.java</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">PostgresContainerBaseTest</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="nc">PostgreSQLContainer</span> <span class="n">postgresContainer</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">postgresContainer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PostgreSQLContainer</span><span class="o">&lt;&gt;(</span><span class="nc">DockerImageName</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"postgres:13"</span><span class="o">));</span>
        <span class="n">postgresContainer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@DynamicPropertySource</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">databaseProperties</span><span class="o">(</span><span class="nc">DynamicPropertyRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.url"</span><span class="o">,</span> <span class="nl">postgresContainer:</span><span class="o">:</span><span class="n">getJdbcUrl</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.username"</span><span class="o">,</span> <span class="nl">postgresContainer:</span><span class="o">:</span><span class="n">getUsername</span><span class="o">);</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"spring.datasource.password"</span><span class="o">,</span> <span class="nl">postgresContainer:</span><span class="o">:</span><span class="n">getPassword</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="pitest-i-buruzko-tip-a">Pitest-i buruzko tip-a</h2>
<p><a href="https://pitest.org/" target="_blank">PIT</a>? Zer zerikusi du <strong>Testcontainers</strong>ek <strong>PIT</strong>rekin? Gogoan izan <a href="https://blog.arima.eu/eu/2020/05/25/mutation-testing.html">gure testen kalitatea neurtu ahal dugula PIT erabiliz</a>. Egia da PIT zuzenean bideratuta dagoela <strong>unitateko test</strong>etara (batez ere denbora/efizientzia dela eta). Baina egia da, halaber, orain arte ez dugula inolako arazorik aurkitu gure <strong>integrazio-test</strong>ak frogatzerakoan.</p>

<p>Hala ere, <code class="highlighter-rouge">@Testcontainers</code> erabiliz egindako testekin Pitest exekutatzen saiatzen bazarete, ez direla pasatzen ikusiko duzue. Aldiz, testak Singleton eredua erabiliz inpelementatuta badaude, Piten estaldura-analisia arazorik gabe egin ahal izango duzue.</p>

<p><em>Norbaitek horren guztiaren zergatia jakin nahi badu eta norbaitek proposatutako irtenbide bat probatu nahi badu, arazoarekin topo egitean ireki genuen <a href="https://github.com/hcoles/pitest/issues/827" target="_blank">issue</a>n egin dezake.</em></p>

<p>Honaino <strong>Testcontainers</strong>i buruzko sarreratxo bat, datu-base baten adibide batekin. Lehen aipatu bezala, Testcontainersek beste modulu asko eskaintzen dizkigu. Are gehiago, gure beharrengatik zerbait zehatzagoa behar badugu, gure ‚Äòdocker-compose.yml‚Äô propioa izateko aukera ere badu, <a href="https://www.testcontainers.org/modules/docker_compose/">dokumentazioan</a> azaltzen den bezala.
Etorkizuneko postetan, gure adibidea garatuko dugu, Testcontainers erabiltzeko beste erabilera-kasu batzuen adibide batzuk sartuz (erabiltzeko erraztasuna eta abantailak modu praktikoan ikusteko).</p>


            </div>

            
          </div>
        </article>
      </div>
    </main>

    <footer>
    <div class="wrapper">
        <div class="footer__container">
            <div class="footer__sello">
                <img src="/assets/images/arima_sello_white.png" alt="" />
            </div>
            <div class="footer__content">
                <div class="footer__data">
                    <dl>
                        <dt>web</dt>
                        <dd><a itemprop="sameAs" href="https://www.arima.eu/eu/">arima.eu</a></dd>
                    </dl>
                    <dl>
                        <dt>social</dt>
                        <dd>
                            <a itemprop="sameAs" href="https://github.com/wearearima" class="social"><span class="icon-github"></span></a>
                            <a itemprop="sameAs" href="https://twitter.com/wearearima" class="social"><span class="icon-twitter"></span></a>
                            <a itemprop="sameAs" href="https://www.linkedin.com/company/arima-software-design/" class="social"><span class="icon-linkedin"></span></a>
                            <a itemprop="sameAs" href="/eu/feed.xml" class="social"><span class="icon-feed"></span></a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>Pribatutasuna</dt>
                        <dd class="politica-cookies">
                            <a href="/eu/cookies.html">Cookie politika</a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</footer>
    <div class="cookies-message" id="cookies-message">
    <h4>Web gune honek cookieak erabiltzen ditu</h4>
    <p>Web gune honek cookieak erabiltzen ditu nabigazio esperientzia hobetzeko. Gure web gunea erabiltzearekin batera, gure cookie politikarekin bat zatozela onartzen duzu.</p>
    <div class="buttons">
        <a class="button" href="/eu/cookies.html">Cookie politika irakurri</a>
        <button class="button" id="accept-cookies">Onartu</button>
    </div>
</div>
<script defer src="/assets/cookies-message.js"></script>


  </body>

</html>