<!DOCTYPE html>
<html lang="es" itemscope itemtype="http://schema.org/Blog">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.googletagmanager.com https://www.google-analytics.com https://www.gstatic.com https://platform.twitter.com https://cdn.syndication.twimg.com https://syndication.twitter.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://www.google-analytics.com https://www.googletagmanager.com https://pbs.twimg.com https://ton.twimg.com https://abs.twimg.com; font-src 'self' data:; connect-src 'self' https://www.google-analytics.com https://www.googletagmanager.com https://stats.g.doubleclick.net https://region1.google-analytics.com https://platform.twitter.com https://cdn.syndication.twimg.com https://syndication.twitter.com; frame-src https://platform.twitter.com https://www.youtube.com; frame-ancestors 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; manifest-src 'self'; upgrade-insecure-requests;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="accelerometer=(), camera=(), geolocation=(), gyroscope=(), microphone=(), payment=(), usb=()">
  <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">

  <title>¿Deberíamos usar Terraform como herramienta de Despliegue Continuo?</title>
  <meta name="description" content="En ARIMA, desde hace unos años, hemos apostado por Kubernetes y el ecosistema cloud native que lo rodea. Nos hemos hecho miembro de la Cloud Native Computing...">
  
  <meta name="keywords" content="terraform,cd,cicd">
  

  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@wearearima">
  <meta name="twitter:creator" content="@urko">
  <meta name="twitter:title"   content="¿Deberíamos usar Terraform como herramienta de Despliegue Continuo?">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary_large_image">
  <meta name="twitter:image" content="https://blog.arima.eu/assets/images/2022-05-13-terraform-cd/header.jpg">
  
  <!-- end of Twitter cards -->

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://blog.arima.eu/eu/2022/05/13/terraform-cd.html">
  <link rel="alternate" type="application/rss+xml" title="ARIMA" href="/eu/feed.xml">

  <!-- SEO Recipes (http://polyglot.untra.io/seo/) -->
  <meta http-equiv="Content-Language" content="eus">
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/eu/2022/05/13/terraform-cd.html" />
  
  
  <link rel="alternate"
      hreflang="es"
      href="https://blog.arima.eu/es/2022/05/13/terraform-cd.html" />
  
  
  <link rel="alternate"
      hreflang="en"
      href="https://blog.arima.eu/en/2022/05/13/terraform-cd.html" />
  
  
  <link rel="alternate"
      hreflang="eu"
      href="https://blog.arima.eu/eu/eus/2022/05/13/terraform-cd.html" />
  

  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-120217722-1"></script>
<script defer src="/assets/google-analytics.js"></script>

  
</head>

  

  <body>
    <nav class="toolbar">
    <div class="wrapper">    
        <a href="/eu/">
            <div class="toolbar__logo">
                <svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" version="1.1" width="100%" height="100%" viewBox="0 0 33 6">
    <path id="path24" d="m30.346988508615652,-0.000015174522529526127 l-0.6439224998849951,0 l-2.7763635316117727,6.135695064030662 l0.7050150612484405,0 l2.3859233880279893,-5.335002838884215 l2.3660424189063254,5.335002838884215 l0.739668694925785,0 L30.346988508615652,-0.000015174522529526127 zm-8.274141805179609,3.3681675186951847 l-2.2194202716340565,-3.324608867598761 l-0.6962481061149294,0 l0,6.092136412934239 l0.6700853029999622,0 l0,-4.926062349034439 l2.2194202716340565,3.2553706313868567 l0.034929758248478535,0 l2.2192131782057056,-3.2639304930920168 l0,4.934622210739599 l0.6873430886958508,0 l0,-6.092136412934239 l-0.6961100438293623,0 l-2.2192131782057056,3.324608867598761 zm-9.143036799396208,-1.5057072863948877 c0,-1.0964906719739773 -0.8613705996531913,-1.8189015812038738 -2.201748299081466,-1.8189015812038738 l-2.619662837493104,0 l0,6.092136412934239 l0.6876192132669849,0 l0,-5.456842805897188 l1.8799251114245357,0 c0.9833486289517317,0 1.5576187057681203,0.4525681720889824 1.5576187057681203,1.2097017461390067 c0,0.7919252700129356 -0.7831583148794242,1.2620273523689407 -1.6968545207625496,1.2620273523689407 l0,0.6178287279128115 l1.7665759749739396,2.3672849794764295 l0.8442508762428699,0 l-1.8711581562910244,-2.4891249464894027 c0.9571858258367647,-0.17416557324290774 1.6534339319516944,-0.7659695603263191 1.6534339319516944,-1.7841098852409623 m2.7743616284710493,4.273234831730365 l0.6872050264102838,0 l0,-6.0920673817914555 l-0.6872050264102838,0 l0,6.0920673817914555 zM2.7761571742923965,-0.000015174522529526127 l-2.7761564381834223,6.135695064030662 l0.7048769989628736,0 l2.386061450313556,-5.335002838884215 l2.3658353254779745,5.335002838884215 l0.739668694925785,0 l-2.7761564381834223,-6.135695064030662 l-0.6441295933133457,0 z" stroke-width="0"/>
</svg>

            </div>
        </a>
        <!-- Language selector -->
        <div class="language-selector">
            
              
                <a class="unselected" href="/es/2022/05/13/terraform-cd.html">ES</a>
              
              
                &nbsp;|&nbsp;
              
            
              
                <a class="unselected" href="/en/2022/05/13/terraform-cd.html">EN</a>
              
              
                &nbsp;|&nbsp;
              
            
              
                <b class="selected">EU</b>
              
              
            
         </div>
    </div>
</nav>
<div id="publisher_id" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Arima 100% Software Design" />
    <meta itemprop="url" content="https://arima.eu" />
    <div itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
        <meta itemprop="url" content="https://arima.eu/img/logo.png" />
    </div>
</div>
    <main aria-label="Content">        
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting" itemref="publisher_id">
          <link itemprop="mainEntityOfPage" href="/eu/2022/05/13/terraform-cd.html" />

          <header class="post-header">
            <div class="post-img" itemprop="image" itemscope itemtype="http://schema.org/ImageObject" style="background-image: url('https://blog.arima.eu/assets/images/2022-05-13-terraform-cd/header.jpg');">
              <meta itemprop="url" content="https://blog.arima.eu/assets/images/2022-05-13-terraform-cd/header.jpg" />
            </div>
            <div class="wrapper">
              <div class="post-info__container">
                <div class="post-info">
                  <h1 class="post-title" itemprop="name headline">¿Deberíamos usar Terraform como herramienta de Despliegue Continuo?</h1>
                    <div class="post-meta" itemscope itemtype="https://schema.org/Person" itemprop="author">
                      
                      <div class="author-photo">
                        <img itemprop="image" src="/assets/images/authors/urko.png" alt="">
                      </div>
                      <div>
                        <span class="post-author" itemprop="name">Urko Lekuona</span>
                      </div>
                      <div>
                        <span class="post-date">2022-05-13</span>
                      </div>
                    </div>
                    <meta  itemprop="datePublished dateModified" content="2022-05-13" />
                </div>
              </div>
            </div>
          </header>
          <div class="wrapper">
            <div class="post-content" itemprop="articleBody">
              <p>En ARIMA, desde hace unos años, hemos apostado por Kubernetes y el ecosistema <em>cloud native</em> que lo rodea. Nos hemos hecho miembro de la <a href="https://www.cncf.io/">Cloud Native Computing Foundation</a> y hemos promovido el uso de muchos de sus proyectos en nuestros clientes. Desde Helm y kustomize para gestionar los despliegues de un <em>cluster</em>, pasando por ArgoCD o Flux que nos ayudan a automatizar estos despliegues y a seguir el patrón <a href="https://www.weave.works/technologies/gitops/">GitOps</a>, o Prometheus y Grafana para monitorizar las métricas de nuestras aplicaciones. Todos estos son solo algunos ejemplos de los proyectos <em>open source</em> que forman parte de un ecosistema cada vez más popular y en constante crecimiento.</p>

<p>Aunque ya hemos usado <a href="https://www.terraform.io/">Terraform</a> previamente en varios proyectos, recientemente nos surgió una pregunta que a primeras parece inocente, pero tiene su miga: ¿Deberíamos usar Terraform como herramienta de Despliegue Continuo? Para el que no lo conozca, Terraform es una herramienta de gestión de infrastructura que nos permite crear y actualizar componentes tanto en entornos <em>cloud</em> como <em>on-premise</em>, utilizando para ello las APIs de los distintos proveedores. Se basa en el concepto de <em>infrastructure as code</em>, que consiste en definir en código la estructura de la infraestructura, que permite almacenarlo en un sistema de control de versiones y que todos los miembros del equipo conozcan lo que está desplegado, entre otras ventajas.</p>

<p>Terraform, para el usuario, provee únicamente un CLI, que sirve para inicializar el proyecto local y para aplicar la configuración, principalmente. Para que este CLI se comunique con las diferentes APIs, Terraform ofrece también una extensa lista de <em>providers</em> (creados por la comunidad) que son los que interpretan nuestros ficheros de configuración y contactan con las APIs para crear la infraestructura definida. Al ser un proyecto con varios años desde su publicación y al tener bastante popularidad dentro de la comunidad <em>cloud-native</em>, la lista de <em>providers</em> es muy extensa (más de 2000) y prácticamente cualquier arquitectura en <em>cloud</em> se puede desarrollar utilizando Terraform.</p>

<h3 id="nuestro-proyecto">Nuestro proyecto</h3>

<p>Sin entrar en demasiados detalles, nuestro proyecto contenía un cluster de Kubernetes donde desplegamos nuestros servicios. Al usar AWS, el cluster tenía que ser desplegado con EKS y decidimos utilizar perfiles de Fargate para minimizar el coste y evitar tener que provisionar los nodos a medida que crece el cluster.</p>

<p>Además, nos interesaba instalar algún tipo de herramienta de Despliegue Continuo, para que los desarrolladores pudieran ver sus cambios cada vez que los aplicasen en su respectiva rama del repositorio. Para esto, decidimos utilizar <a href="https://argo-cd.readthedocs.io/en/stable/">ArgoCD</a>, ya que habíamos trabajado con esta herramienta anteriormente, es sencilla de instalar, y nos encajaba para que los desarrolladores pudieran consultar el estado de los despliegues.</p>

<p>Sin embargo, durante el desarrollo del plan de Terraform, nos dimos cuenta que al igual que desplegábamos ciertos componentes de Kubernetes para instalar Argo con el CLI de Terraform, podíamos definir los componentes de nuestros despliegues en el plan y desplegarlos desde el pipeline del repositorio para automatizarlo. De esta manera, podíamos evitar usar ArgoCD en el proyecto y aprovechar Terraform para satisfacer nuestras necesidades.</p>

<p>En este momento nos surgió una duda que no nos habíamos planteado antes: ¿deberíamos usar Terraform como herramienta de Despliegue Continuo? ¿cuáles son sus ventajas/desventajas?</p>

<h3 id="qué-nos-ofrece-terraform">¿Qué nos ofrece Terraform?</h3>

<p>Al usar Terraform como herramienta de despliegue de nuestros servicios, obtendríamos ciertas ventajas que nos hicieron plantearnos esta alternativa:</p>
<ul>
  <li>Eliminariamos la necesidad de usar ArgoCD en el proyecto, simplificando la arquitectura y reduciendo el coste de mantener sus contenedores activos.</li>
  <li>Unificaríamos el despliegue de la infraestructura con el despliegue de nuestros servicios en una sola pieza: el plan de Terraform. Conocer el estado de la arquitectura consistiría en consultar el plan únicamente, ya que estaría todo centralizado en él.</li>
  <li>Minimizariamos el número de tecnologías que habría que conocer para trabajar con el proyecto.</li>
</ul>

<h3 id="qué-implicaciones-tiene-utilizar-terraform-para-automatizar-los-despliegues">¿Qué implicaciones tiene utilizar Terraform para automatizar los despliegues?</h3>

<p>En esencia, Terraform no está pensado para utilizarlo como sustituto de ArgoCD. Su forma de interactuar con los componentes desplegados tiene implicaciones subyacentes que son importantes de identificar antes de tomar una decisión.</p>

<ul>
  <li>En vez de usar un operador de Kubernetes como hace ArgoCD para sincronizar el repositorio con el cluster, Terraform hará la sincronización de manera externa, desde la máquina que ejecute el pipeline. Esto tiene ciertas implicaciones de seguridad, porque habrá que crear un usuario y rol para que el pipeline pueda efectuar cambios, además de exponer el cluster a modificaciones desde fuera.</li>
  <li>El CLI de Terraform está pensado para ser utilizado manualmente. Cada vez que se intenta aplicar una actualización del plan, el CLI notifica al usuario de los cambios que tendrá que efectuar en la infraestructura, ya sea añadir, modificar, y/o eliminar componentes. En ocasiones puede darse el caso de que los cambios propuestos por Terraform no sean correctos, porque alguna llamada a las APIs haya fallado o se hayan actualizado las APIs y los <em>providers</em> aún no. En estos casos, Terraform puede intentar aplicar unos cambios erróneos que un usuario debería identificar y denegar. Al ejecutarlo desde un pipeline, perdemos esta capacidad de supervisión sobre los cambios de Terraform y nos exponemos al riesgo de cambios inesperados sobre la infraestructura. Un ejemplo que nos ha ocurrido es que Terraform intente constantemente intentar eliminar una instancia de RDS y recrearla, cuando no ha habido ningún cambio en el plan relacionado con ella.</li>
  <li>En caso de querer gestionar múltiples entornos o proyectos en la misma infraestructura, ArgoCD nos aporta utilidades para hacerlo de manera sencilla, mientras que diseñar un plan de Terraform para que sea flexible es más complicado y propenso a errores.</li>
  <li>La interfaz gráfica de Argo hará que los desarrolladores puedan conocer el estado de sus despliegues sin conocer las herramientas que se han usado para ello. Trabajar directamente con descriptores YAML de K8s o Charts de Helm es más sencillo y llevadero que gestionar esos mismos recursos desde Terraform. En general, la experiencia de usuario empeorará si prescindimos de ArgoCD.</li>
</ul>

<h3 id="conclusiones">Conclusiones</h3>

<p>En nuestro proyecto, después de sopesar ambas opciones, nos acabamos decantando por utilizar Terraform para desplegar la infraestructura, pero instalando ArgoCD para que gestionase los despliegues de Kubernetes. Esto no quiere decir que creamos que esta es la mejor decisión, sino que era la que más se ajustaba a las características de nuestro proyecto.</p>

<p>En definitiva, porque una herramienta sea capaz de cumplir múltiples roles no significa que sea la herramienta más adecuada para cada una de esas funciones.</p>

            </div>

            
          </div>
        </article>
      </div>
    </main>

    <footer>
    <div class="wrapper">
        <div class="footer__container">
            <div class="footer__sello">
                <img src="/assets/images/arima_sello_white.png" alt="" />
            </div>
            <div class="footer__content">
                <div class="footer__data">
                    <dl>
                        <dt>web</dt>
                        <dd><a itemprop="sameAs" href="https://www.arima.eu/eu/">arima.eu</a></dd>
                    </dl>
                    <dl>
                        <dt>social</dt>
                        <dd>
                            <a itemprop="sameAs" href="https://github.com/wearearima" class="social"><span class="icon-github"></span></a>
                            <a itemprop="sameAs" href="https://twitter.com/wearearima" class="social"><span class="icon-twitter"></span></a>
                            <a itemprop="sameAs" href="https://www.linkedin.com/company/arima-software-design/" class="social"><span class="icon-linkedin"></span></a>
                            <a itemprop="sameAs" href="/eu/feed.xml" class="social"><span class="icon-feed"></span></a>
                        </dd>
                    </dl>
                    <dl>
                        <dt>Pribatutasuna</dt>
                        <dd class="politica-cookies">
                            <a href="/eu/cookies.html">Cookie politika</a>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</footer>
    <div class="cookies-message" id="cookies-message">
    <h4>Web gune honek cookieak erabiltzen ditu</h4>
    <p>Web gune honek cookieak erabiltzen ditu nabigazio esperientzia hobetzeko. Gure web gunea erabiltzearekin batera, gure cookie politikarekin bat zatozela onartzen duzu.</p>
    <div class="buttons">
        <a class="button" href="/eu/cookies.html">Cookie politika irakurri</a>
        <button class="button" id="accept-cookies">Onartu</button>
    </div>
</div>
<script defer src="/assets/cookies-message.js"></script>


  </body>

</html>